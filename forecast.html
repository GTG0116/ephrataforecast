
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">Ephrata, PA â€” Weather</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(ellipse at 20% 0%, #0d1b3e 0%, #0a0f1e 45%, #050810 100%);
      min-height: 100vh;
      color: #e2e8f0;
      -webkit-font-smoothing: antialiased;
    }
 
    /* â”€â”€ Glass card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .glass {
      background: rgba(13, 27, 62, 0.55);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(99, 143, 255, 0.12);
      border-radius: 16px;
    }
    .glass-light {
      background: rgba(20, 38, 80, 0.45);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(99, 143, 255, 0.1);
      border-radius: 12px;
    }
 
    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
    ::-webkit-scrollbar-thumb { background: rgba(99,131,255,0.35); border-radius: 4px; }
 
    /* â”€â”€ Tab nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-btn {
      padding: 8px 18px;
      border-radius: 9px;
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.2s;
      color: rgba(148,163,184,0.85);
      white-space: nowrap;
      border: none;
      background: transparent;
    }
    .tab-btn:hover { color: #e2e8f0; background: rgba(99,131,255,0.08); }
    .tab-btn.active {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #fff;
      box-shadow: 0 4px 20px rgba(99,131,255,0.35);
    }
 
    /* â”€â”€ Maps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .map-container { height: 520px; border-radius: 14px; overflow: hidden; }
    @media (max-width: 640px) { .map-container { height: 340px; } }
 
    .leaflet-control-zoom a {
      background: rgba(10,15,35,0.92) !important;
      border: 1px solid rgba(99,131,255,0.25) !important;
      color: #94a3b8 !important;
    }
    .leaflet-control-attribution {
      background: rgba(10,15,35,0.75) !important;
      color: #475569 !important;
      font-size: 10px !important;
    }
    .leaflet-control-attribution a { color: #64748b !important; }
    .leaflet-popup-content-wrapper {
      background: rgba(10,20,50,0.95) !important;
      border: 1px solid rgba(99,131,255,0.25) !important;
      border-radius: 12px !important;
      color: #e2e8f0 !important;
    }
    .leaflet-popup-tip { background: rgba(10,20,50,0.95) !important; }
 
    /* â”€â”€ Station marker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stn-pin {
      background: rgba(5, 12, 35, 0.92);
      border: 1.5px solid rgba(99,131,255,0.45);
      border-radius: 9px;
      padding: 4px 7px;
      font-family: 'Inter', sans-serif;
      line-height: 1.35;
      white-space: nowrap;
      pointer-events: none;
      box-shadow: 0 2px 12px rgba(0,0,0,0.5);
    }
 
    /* â”€â”€ Forecast cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .day-card {
      background: rgba(13,27,62,0.55);
      border: 1px solid rgba(99,131,255,0.12);
      border-radius: 16px;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: default;
    }
    .day-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(37,99,235,0.18);
      border-color: rgba(99,131,255,0.28);
    }
 
    .hourly-card {
      flex-shrink: 0;
      width: 88px;
      background: rgba(13,27,62,0.55);
      border: 1px solid rgba(99,131,255,0.1);
      border-radius: 13px;
      padding: 10px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 4px;
      transition: border-color 0.2s;
    }
    .hourly-card:hover { border-color: rgba(99,131,255,0.3); }
 
    /* â”€â”€ Precip type badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .badge-rain   { background: rgba(6,182,212,0.15);  color:#22d3ee; border:1px solid rgba(6,182,212,0.3); }
    .badge-snow   { background: rgba(226,232,240,0.12); color:#cbd5e1; border:1px solid rgba(226,232,240,0.25); }
    .badge-frzr   { background: rgba(125,211,252,0.13); color:#7dd3fc; border:1px solid rgba(125,211,252,0.3); }
    .badge-mix    { background: rgba(139,92,246,0.15); color:#a78bfa; border:1px solid rgba(139,92,246,0.3); }
    .badge-tstm   { background: rgba(250,204,21,0.13);  color:#fbbf24; border:1px solid rgba(250,204,21,0.3); }
    .badge-none   { background: rgba(71,85,105,0.18);   color:#94a3b8; border:1px solid rgba(71,85,105,0.3); }
 
    /* â”€â”€ Radar legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dbz-bar {
      height: 14px;
      border-radius: 4px;
      background: linear-gradient(to right,
        #646464,#04e9e7,#019ff4,#0300f4,
        #02fd02,#01c501,#008e00,#fdf802,
        #e5bc00,#fd9500,#fd0000,#d40000,
        #bc0000,#f800fd,#9854c6);
      flex: 1;
    }
 
    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeUp {
      from { opacity:0; transform:translateY(14px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .fade-up { animation: fadeUp 0.45s ease both; }
 
    @keyframes pulse-soft {
      0%,100% { opacity:1; }
      50% { opacity:0.55; }
    }
    .pulse-soft { animation: pulse-soft 1.8s ease infinite; }
 
    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      width:36px; height:36px;
      border:3px solid rgba(99,131,255,0.2);
      border-top-color:#4f7bff;
      border-radius:50%;
      animation: spin 0.85s linear infinite;
    }
 
    /* â”€â”€ SPC risk colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .risk-tstm { color:#6bc466; }
    .risk-mrgl { color:#8ad48a; }
    .risk-slgt { color:#f0e070; }
    .risk-enh  { color:#f09040; }
    .risk-mdt  { color:#e84040; }
    .risk-high { color:#e040e0; }
 
    /* â”€â”€ Tab content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
 
    /* â”€â”€ Snowfall image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wx-image {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(99,131,255,0.12);
    }
 
    /* â”€â”€ Stat pill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stat-pill {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 12px 16px;
      background: rgba(13,27,62,0.5);
      border: 1px solid rgba(99,131,255,0.1);
      border-radius: 12px;
      min-width: 80px;
    }
 
    /* â”€â”€ Responsive hourly scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .h-scroll { overflow-x: auto; scrollbar-width: thin; }
 
    /* â”€â”€ Section divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: rgba(148,163,184,0.6);
      margin-bottom: 10px;
    }

    /* â”€â”€ Search bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-wrap { position: relative; flex: 1; max-width: 420px; }
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      background: rgba(10,20,50,0.65);
      border: 1px solid rgba(99,131,255,0.22);
      border-radius: 10px;
      color: #e2e8f0;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.2s;
    }
    .search-input:focus {
      border-color: rgba(99,131,255,0.55);
      background: rgba(15,25,65,0.85);
      box-shadow: 0 0 0 3px rgba(99,131,255,0.1);
    }
    .search-input::placeholder { color: rgba(148,163,184,0.45); }
    .search-icon-wrap {
      position: absolute; left: 10px; top: 50%;
      transform: translateY(-50%); color: rgba(148,163,184,0.45);
      pointer-events: none;
    }
    .search-dropdown {
      position: absolute; top: calc(100% + 6px); left: 0; right: 0;
      background: rgba(7,12,32,0.98);
      border: 1px solid rgba(99,131,255,0.22);
      border-radius: 14px; overflow: hidden; z-index: 9000;
      box-shadow: 0 16px 48px rgba(0,0,0,0.65);
      max-height: 420px; overflow-y: auto;
    }
    .search-dropdown.hidden { display: none; }
    .sdrop-label {
      padding: 9px 14px 4px;
      font-size: 0.67rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: rgba(148,163,184,0.38);
    }
    .sdrop-item {
      padding: 10px 14px; cursor: pointer;
      display: flex; align-items: center; gap: 10px;
      transition: background 0.12s;
      border-top: 1px solid rgba(255,255,255,0.03);
    }
    .sdrop-item:first-child { border-top: none; }
    .sdrop-item:hover { background: rgba(99,131,255,0.1); }
    .sdrop-item-icon { font-size: 1.1rem; width: 22px; text-align: center; flex-shrink: 0; }
    .sdrop-item-text { flex: 1; min-width: 0; }
    .sdrop-item-name { font-size: 0.855rem; font-weight: 500; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sdrop-item-sub  { font-size: 0.72rem; color: #64748b; }
    .sdrop-fav-btn {
      padding: 3px 7px; font-size: 0.78rem; cursor: pointer;
      background: none; border: none; flex-shrink: 0;
      color: #f59e0b; opacity: 0.55; transition: opacity 0.15s;
    }
    .sdrop-fav-btn:hover { opacity: 1; }
    .sdrop-fav-btn.active { opacity: 1; }
    .sdrop-divider { height: 1px; background: rgba(255,255,255,0.05); margin: 2px 0; }

    /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(5px);
      z-index: 8000;
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
      opacity: 0; pointer-events: none; transition: opacity 0.22s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal-card {
      background: rgba(9,16,44,0.99);
      border: 1px solid rgba(99,131,255,0.22);
      border-radius: 20px; padding: 22px;
      max-width: 540px; width: 100%;
      max-height: 88vh; overflow-y: auto;
      transform: translateY(18px); transition: transform 0.22s;
      scrollbar-width: thin;
    }
    .modal-overlay.open .modal-card { transform: translateY(0); }
    .modal-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .modal-close {
      width: 30px; height: 30px; flex-shrink: 0;
      border-radius: 8px;
      background: rgba(99,131,255,0.1);
      border: 1px solid rgba(99,131,255,0.18);
      color: #94a3b8; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; transition: background 0.15s;
    }
    .modal-close:hover { background: rgba(99,131,255,0.22); }
    .mdetail-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 9px; margin-top: 12px;
    }
    @media (max-width: 400px) { .mdetail-grid { grid-template-columns: 1fr; } }
    .mdetail-item {
      background: rgba(18,32,72,0.55);
      border: 1px solid rgba(99,131,255,0.1);
      border-radius: 10px; padding: 10px 12px;
    }
    .mdetail-lbl { font-size: 0.67rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: rgba(148,163,184,0.45); margin-bottom: 3px; }
    .mdetail-val { font-size: 0.92rem; font-weight: 600; color: #e2e8f0; }
    .mdetail-desc {
      font-size: 0.84rem; line-height: 1.65; color: #94a3b8;
      background: rgba(8,18,48,0.55);
      border: 1px solid rgba(99,131,255,0.09);
      border-radius: 10px; padding: 12px; margin-top: 10px;
    }

    /* â”€â”€ Station plot markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stn-plot {
      display: flex; flex-direction: column; align-items: center;
      gap: 2px; cursor: pointer;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.8));
      transition: filter 0.15s;
    }
    .stn-plot:hover { filter: drop-shadow(0 3px 14px rgba(99,131,255,0.55)); }
    .stn-circle {
      width: 38px; height: 38px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px; border: 2px solid currentColor;
      transition: transform 0.15s;
    }
    .stn-plot:hover .stn-circle { transform: scale(1.18); }
    .stn-temp-lbl {
      font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800;
      line-height: 1; text-shadow: 0 1px 5px rgba(0,0,0,1), 0 0 10px rgba(0,0,0,0.7);
    }
    .stn-wind-lbl {
      font-family: 'Inter', sans-serif; font-size: 9px;
      color: rgba(203,213,225,0.9); line-height: 1;
      text-shadow: 0 1px 4px rgba(0,0,0,1);
      display: flex; align-items: center; gap: 2px;
    }
    .stn-id-lbl {
      font-family: 'Inter', sans-serif; font-size: 8px; font-weight: 700;
      color: rgba(148,163,184,0.75); line-height: 1;
      text-shadow: 0 1px 4px rgba(0,0,0,1);
      letter-spacing: 0.05em;
    }

    /* â”€â”€ Day/Hourly cards clickable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .day-card   { cursor: pointer; }
    .hourly-card { cursor: pointer; }
    .hourly-card:hover { border-color: rgba(99,131,255,0.45); background: rgba(18,35,80,0.65); }

    /* â”€â”€ Snowfall chart container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .snow-chart-wrap { position: relative; height: 200px; margin-bottom: 8px; }
  /* Weather icon circle */
      .wx-ico { display:flex;align-items:center;justify-content:center;border-radius:14px;border:1px solid rgba(99,131,255,0.13);background:rgba(99,131,255,0.07);font-size:26px; }
      /* RainViewer slider */
      .rv-slider { -webkit-appearance:none;flex:1;height:5px;border-radius:3px;background:rgba(99,131,255,0.22);cursor:pointer; }
      .rv-slider::-webkit-slider-thumb { -webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#6385ff;cursor:pointer; }
      .rv-frame-tick { cursor:pointer;font-size:10px;color:#475569;padding:2px 4px;border-radius:3px;transition:all 0.15s; }
      .rv-frame-tick:hover { color:#e2e8f0;background:rgba(99,131,255,0.2); }
      .rv-frame-tick.active { color:#6385ff;font-weight:700;background:rgba(99,131,255,0.15); }
      /* 3-chart layout */
      .chart-wrap-3 { position:relative;height:165px; }
  </style>
</head>
<body>
 
<div id="app" class="max-w-6xl mx-auto px-4 py-6 space-y-5">
 
  <!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="glass px-6 py-5 fade-up" style="animation-delay:0s">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <!-- Location search bar -->
        <div class="search-wrap" id="search-wrap">
          <span class="search-icon-wrap">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </span>
          <input type="text" id="location-search" class="search-input"
            placeholder="Search cities across the USâ€¦"
            autocomplete="off" spellcheck="false" />
          <div id="search-dropdown" class="search-dropdown hidden"></div>
        </div>
        <p id="location-subtitle" class="text-sm text-slate-400 mt-1.5 ml-1">40.1773Â°N 76.1869Â°W Â· Lancaster County, PA</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="hdr-current" class="text-right">
          <div id="hdr-temp" class="text-3xl font-black text-white">--Â°F</div>
          <div id="hdr-desc" class="text-sm text-slate-400 mt-0.5">Loadingâ€¦</div>
        </div>
        <button onclick="refreshAll()" id="refresh-btn"
          class="p-2.5 rounded-xl bg-blue-600/20 border border-blue-500/25 text-blue-400 hover:bg-blue-600/35 transition-all"
          title="Refresh">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        </button>
      </div>
    </div>
 
    <!-- Current stats strip -->
    <div id="hdr-stats" class="flex flex-wrap gap-2 mt-4">
      <div class="stat-pill">
        <span class="text-xs text-slate-500 font-medium">Feels Like</span>
        <span id="stat-feels" class="text-sm font-bold text-white">--</span>
      </div>
      <div class="stat-pill">
        <span class="text-xs text-slate-500 font-medium">Wind</span>
        <span id="stat-wind" class="text-sm font-bold text-white">--</span>
      </div>
      <div class="stat-pill">
        <span class="text-xs text-slate-500 font-medium">Humidity</span>
        <span id="stat-humid" class="text-sm font-bold text-white">--</span>
      </div>
      <div class="stat-pill">
        <span class="text-xs text-slate-500 font-medium">Cloud Cover</span>
        <span id="stat-cloud" class="text-sm font-bold text-white">--</span>
      </div>
      <div class="stat-pill">
        <span class="text-xs text-slate-500 font-medium">Visibility</span>
        <span id="stat-vis" class="text-sm font-bold text-white">--</span>
      </div>
      <div class="stat-pill">
        <span class="text-xs text-slate-500 font-medium">Pressure</span>
        <span id="stat-pressure" class="text-sm font-bold text-white">--</span>
      </div>
      <div class="stat-pill">
        <span class="text-xs text-slate-500 font-medium">Precip Type</span>
        <span id="stat-ptype" class="text-sm font-bold">--</span>
      </div>
      <div class="stat-pill ml-auto">
        <span class="text-xs text-slate-500 font-medium">Updated</span>
        <span id="stat-updated" class="text-xs font-semibold text-slate-300">--</span>
      </div>
    </div>
  </header>
 
  <!-- â•â• TAB NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <nav class="glass px-3 py-2 fade-up" style="animation-delay:0.06s">
    <div class="flex gap-1 overflow-x-auto scrollbar-none" style="scrollbar-width:none">
      <button class="tab-btn active" data-tab="forecast">
        <span class="mr-1.5">ğŸ“…</span>Forecast
      </button>
      <button class="tab-btn" data-tab="radar">
        <span class="mr-1.5">ğŸ“¡</span>Radar
      </button>
      <button class="tab-btn" data-tab="snowfall">
        <span class="mr-1.5">â„ï¸</span>Snowfall
      </button>
      <button class="tab-btn" data-tab="spc">
        <span class="mr-1.5">â›ˆï¸</span>SPC Outlooks
      </button>
      <button class="tab-btn" data-tab="conditions">
        <span class="mr-1.5">ğŸ—ºï¸</span>Conditions Map
      </button>
    </div>
  </nav>
 
  <!-- â•â• GLOBAL LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="global-loading" class="glass flex items-center justify-center gap-4 py-10 fade-up">
    <div class="spinner"></div>
    <span id="loading-text" class="text-slate-400 font-medium">Fetching weather dataâ€¦</span>
  </div>
 
  <!-- â•â• ERROR BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="global-error" class="hidden glass px-5 py-4 border-red-500/30 fade-up">
    <p class="text-red-400 font-semibold">âš  <span id="error-text">Error loading data.</span></p>
  </div>
 
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB: FORECAST
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-forecast" class="tab-panel space-y-5">
 
    <!-- 7-Day Forecast -->
    <section class="glass p-5 fade-up" style="animation-delay:0.1s">
      <p class="section-title">7-Day Forecast</p>
      <div id="daily-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
        <!-- injected -->
      </div>
    </section>
 
    <!-- Hourly Scroll -->
    <section class="glass p-5 fade-up" style="animation-delay:0.15s">
      <p class="section-title">Hourly Forecast Â· Next 48 Hours</p>
      <div id="hourly-scroll" class="h-scroll flex gap-2 pb-2">
        <!-- injected -->
      </div>
    </section>
 
    <!-- Chart -->
            <section class="glass p-5 fade-up">
          <p class="section-title">&#127777; Temperature &#183; 48h</p>
          <div class="chart-wrap-3"><canvas id="chart-temp"></canvas></div>
        </section>
        <section class="glass p-5 fade-up">
          <p class="section-title">&#128168; Wind Speed &#183; 48h</p>
          <div class="chart-wrap-3"><canvas id="chart-wind"></canvas></div>
        </section>
        <section class="glass p-5 fade-up">
          <p class="section-title">&#128336; Pressure &#183; 48h</p>
          <div class="chart-wrap-3"><canvas id="chart-pressure"></canvas></div>
        </section>
  </div>
 
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB: RADAR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-radar" class="tab-panel space-y-4">
          <div id="radar-map" class="map-container"></div>
          <div id="rv-controls" class="mt-3 glass-light p-3 flex flex-col gap-2">
            <div class="flex items-center gap-3">
              <button id="rv-play-btn" onclick="toggleRainViewerPlay()"
                class="tab-btn active text-xs px-3 py-1.5">&#9654; Play</button>
              <input id="rv-slider" type="range" class="rv-slider" min="0" max="9" value="9"
                oninput="setRainViewerFrame(parseInt(this.value))" />
              <span id="rv-time-label" class="text-xs text-slate-400 whitespace-nowrap">&mdash;</span>
            </div>
            <div id="rv-ticks" class="flex flex-wrap gap-1"></div>
          </div>
          <div class="glass p-4">
            <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider mb-3">
              Precip Type Outlook &mdash; <span id="radar-ptype-location"></span>
            </p>
            <div id="radar-ptype-grid" class="flex flex-wrap gap-2">
              <span class="text-xs text-slate-500">Loading...</span>
            </div>
          </div>
        </div>
 
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB: SNOWFALL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-snowfall" class="tab-panel space-y-4">

    <!-- NWS Gridded Snowfall Forecast Chart -->
    <section class="glass p-5 fade-up">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <p class="section-title mb-0">NWS Snowfall Forecast</p>
          <p id="snow-location-label" class="text-xs text-slate-500 mt-1">Ephrata, PA Â· NWS gridded forecast</p>
        </div>
      </div>
      <div id="snow-forecast-wrap">
        <div class="snow-chart-wrap"><canvas id="snow-forecast-chart"></canvas></div>
        <p class="text-xs text-slate-600 mt-1">
          Source: NWS Gridded Forecast API â€” predicted snowfall amounts (inches per 6-h period). Updates with NWS model runs.
        </p>
      </div>
    </section>

    <!-- WPC Snowfall Probability Maps -->
    <section class="glass p-5 fade-up">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <p class="section-title mb-0">WPC Probabilistic Snowfall â‰¥ 0.1"</p>
        <div class="flex gap-2 flex-wrap">
          <button onclick="setSnowMapDay(1)"  id="snowmap-d1"  class="tab-btn active text-xs px-3 py-1.5">Day 1</button>
          <button onclick="setSnowMapDay(2)"  id="snowmap-d2"  class="tab-btn text-xs px-3 py-1.5">Day 2</button>
          <button onclick="setSnowMapDay(3)"  id="snowmap-d3"  class="tab-btn text-xs px-3 py-1.5">Day 3</button>
          <button onclick="setSnowMapDay(47)" id="snowmap-d47" class="tab-btn text-xs px-3 py-1.5">Days 4â€“7</button>
        </div>
      </div>
      <div class="relative">
        <img id="snow-wpc-map" src="https://www.wpc.ncep.noaa.gov/wwd/pwpf_d47/pwpf_medr_d1.gif"
          alt="WPC Day 1 Snowfall Probability" class="wx-image"
          onerror="this.style.opacity='0.3'" />
      </div>
      <p class="text-xs text-slate-600 mt-2">
        Source: NWS/WPC â€” Probabilistic snowfall (chance of â‰¥0.1" accumulation). Updates daily.
      </p>
    </section>

    <!-- WPC Higher Threshold Probabilities -->
    <section class="glass p-5 fade-up">
      <p class="section-title">WPC Snowfall Probability Thresholds Â· Days 1â€“3</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-1 text-center">â‰¥1" Probability</p>
          <img src="https://www.wpc.ncep.noaa.gov/wwd/pwpf_d47/pwpf_1in_d1.gif"
            alt="WPC 1in Prob" class="wx-image" onerror="this.style.opacity='0.3'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-1 text-center">â‰¥4" Probability</p>
          <img src="https://www.wpc.ncep.noaa.gov/wwd/pwpf_d47/pwpf_4in_d1.gif"
            alt="WPC 4in Prob" class="wx-image" onerror="this.style.opacity='0.3'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-1 text-center">â‰¥8" Probability</p>
          <img src="https://www.wpc.ncep.noaa.gov/wwd/pwpf_d47/pwpf_8in_d1.gif"
            alt="WPC 8in Prob" class="wx-image" onerror="this.style.opacity='0.3'" />
        </div>
      </div>
    </section>

    <!-- NWS Winter Storm Severity Index -->
    <section class="glass p-5 fade-up">
      <p class="section-title">NWS Winter Weather Outlook (Day 4â€“7)</p>
      <img src="https://www.wpc.ncep.noaa.gov/wwd/wssi/day4_7_wssi.png"
        alt="Winter Storm Severity Index" class="wx-image" onerror="this.style.display='none'" />
      <p class="text-xs text-slate-600 mt-2">Source: WPC Winter Storm Severity Index (WSSI).</p>
    </section>
  </div>

  <div id="tab-spc" class="tab-panel space-y-4">
 
    <!-- Convective Outlooks -->
    <section class="glass p-5 fade-up">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
        <p class="section-title mb-0">SPC Convective Outlooks</p>
        <div class="flex gap-2">
          <button onclick="setSpcDay(1)" id="spc-d1" class="tab-btn active text-xs px-3 py-1.5">Day 1</button>
          <button onclick="setSpcDay(2)" id="spc-d2" class="tab-btn text-xs px-3 py-1.5">Day 2</button>
          <button onclick="setSpcDay(3)" id="spc-d3" class="tab-btn text-xs px-3 py-1.5">Day 3</button>
        </div>
      </div>
 
      <img id="spc-outlook-img" src="https://www.spc.noaa.gov/products/outlook/day1otlk.gif"
        alt="SPC Day 1 Convective Outlook" class="wx-image"
        onerror="this.src=''; handleSpcImgError()" />
 
      <!-- Risk Legend -->
      <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2">
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-green-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-tstm">TSTM</p>
          <p class="text-xs text-slate-500 mt-0.5">Gen. Thunder</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-green-300/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-mrgl">MRGL</p>
          <p class="text-xs text-slate-500 mt-0.5">Marginal</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-yellow-300/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-slgt">SLGT</p>
          <p class="text-xs text-slate-500 mt-0.5">Slight</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-orange-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-enh">ENH</p>
          <p class="text-xs text-slate-500 mt-0.5">Enhanced</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-red-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-mdt">MDT</p>
          <p class="text-xs text-slate-500 mt-0.5">Moderate</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-fuchsia-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-high">HIGH</p>
          <p class="text-xs text-slate-500 mt-0.5">High</p>
        </div>
      </div>
    </section>
 
    <!-- Tornado / Wind / Hail breakdown (Day 1) -->
    <section class="glass p-5 fade-up">
            <div class="flex items-center justify-between mb-3">
              <p class="section-title mb-0">&#9832; SPC Hazard Probabilities</p>
              <div class="flex gap-1">
                <button onclick="setSpcHazardDay(1)" id="haz-d1" class="tab-btn active text-xs px-3 py-1.5">Day 1</button>
                <button onclick="setSpcHazardDay(2)" id="haz-d2" class="tab-btn text-xs px-3 py-1.5">Day 2</button>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <p class="text-xs text-slate-500 mb-1">Tornado</p>
                <img id="haz-torn" src="https://www.spc.noaa.gov/products/outlook/day1probotlk_torn.gif"
                  alt="Tornado Probability" class="w-full rounded-lg" onerror="this.style.opacity='0.3'" />
              </div>
              <div>
                <p class="text-xs text-slate-500 mb-1">Wind</p>
                <img id="haz-wind" src="https://www.spc.noaa.gov/products/outlook/day1probotlk_wind.gif"
                  alt="Wind Probability" class="w-full rounded-lg" onerror="this.style.opacity='0.3'" />
              </div>
              <div>
                <p class="text-xs text-slate-500 mb-1">Hail</p>
                <img id="haz-hail" src="https://www.spc.noaa.gov/products/outlook/day1probotlk_hail.gif"
                  alt="Hail Probability" class="w-full rounded-lg" onerror="this.style.opacity='0.3'" />
              </div>
            </div>
          </section>
 
    <!-- Fire Weather -->
    <section class="glass p-5 fade-up">
      <p class="section-title">SPC Fire Weather Outlook</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">Day 1</p>
          <img src="https://www.spc.noaa.gov/products/fire_wx/fwdy1.gif"
            alt="Fire Day 1" class="wx-image" onerror="this.style.display='none'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">Day 2</p>
          <img src="https://www.spc.noaa.gov/products/fire_wx/fwdy2.gif"
            alt="Fire Day 2" class="wx-image" onerror="this.style.display='none'" />
        </div>
      </div>
      <p class="text-xs text-slate-600 mt-2">Source: NOAA Storm Prediction Center (SPC). Updates daily.</p>
    </section>
  </div>
 
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB: CONDITIONS MAP
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-conditions" class="tab-panel space-y-4">
 
    <section class="glass p-4 fade-up">
      <p class="section-title" id="conditions-map-title">Current Surface Observations</p>
      <div id="conditions-map" class="map-container"></div>
      <div class="mt-3 flex flex-wrap gap-3 text-xs text-slate-500">
        <span>ğŸŒ¡ Temperature</span>
        <span>ğŸ’¨ Wind speed &amp; direction</span>
        <span>â˜ Cloud cover</span>
        <span id="conditions-legend-text">Sources: NWS ASOS station observations</span>
      </div>
    </section>
 
    <!-- Station Table -->
    <section class="glass p-5 fade-up">
      <p class="section-title">Station Observations</p>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs text-slate-500 border-b border-slate-700/50">
              <th class="text-left pb-2 font-semibold">Station</th>
              <th class="text-right pb-2 font-semibold">Temp</th>
              <th class="text-right pb-2 font-semibold">Wind</th>
              <th class="text-right pb-2 font-semibold">Humidity</th>
              <th class="text-right pb-2 font-semibold">Sky</th>
              <th class="text-right pb-2 font-semibold">Weather</th>
            </tr>
          </thead>
          <tbody id="station-table-body">
            <tr><td colspan="6" class="py-4 text-center text-slate-500 pulse-soft">Loading stationsâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>
 
  <!-- â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <footer class="text-center text-xs text-slate-700 py-2 fade-up" style="animation-delay:0.3s">
    Data: NWS Â· Open-Meteo HRRR Â· IEM/NOAA MRMS Â· WPC Â· SPC Â·
    <span id="footer-updated"></span>
  </footer>

</div><!-- #app -->

<!-- â•â• DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="detail-modal" class="modal-overlay" onclick="closeModal()">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-top">
      <div style="flex:1;min-width:0">
        <p id="modal-eyebrow" class="text-xs font-bold uppercase tracking-widest text-slate-500 mb-1"></p>
        <h3 id="modal-title" class="text-xl font-extrabold text-white leading-tight"></h3>
        <p id="modal-subtitle" class="text-sm text-slate-400 mt-1"></p>
      </div>
      <button class="modal-close" onclick="closeModal()" title="Close">âœ•</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>
 
<script>
// ============================================================
// CONFIG  (mutable â€” updated when user picks a location)
// ============================================================
let CFG = {
  lat: 40.1773,
  lon: -76.1869,
  nwsOffice: 'CTP',
  nwsX: 92,
  nwsY: 76,
  locationName: 'Ephrata, PA',
  locationSubtitle: '40.1773\u00b0N 76.1869\u00b0W \u00b7 Lancaster County, PA',
  timezone: 'America/New_York',
  userAgent: '(WeatherApp, weather@example.com)',
  refreshMs: 600_000,
};

// ============================================================
// STATE
// ============================================================
let ST = {
  openMeteo: null,
  nwsForecast: null,
  nwsHourly: null,
  stations: [],
  radarProduct: 'nexrad-n0q-900913',
  snowMapDay: 1,
  spcDay: 1,
  maps: { radar: null, conditions: null },
  layers: { radar: null },
  tempChart: null, windChart: null, pressChart: null,
  snowChart: null,
  mapsInited: { radar: false, conditions: false },
  stationMarkers: [],
  favorites: [],
  searchTimeout: null,
  nwsSnowfall: null,
};

// ============================================================
// FAVORITES (localStorage)
// ============================================================
function loadFavorites() {
  try { ST.favorites = JSON.parse(localStorage.getItem('wxFavorites') || '[]'); }
  catch(e) { ST.favorites = []; }
}
function saveFavorites() {
  try { localStorage.setItem('wxFavorites', JSON.stringify(ST.favorites)); }
  catch(e) {}
}
function isFavorite(name) {
  return ST.favorites.some(f => f.name === name);
}
function toggleFavorite(loc) {
  if (isFavorite(loc.name)) {
    ST.favorites = ST.favorites.filter(f => f.name !== loc.name);
  } else {
    ST.favorites.unshift({ name: loc.name, subtitle: loc.subtitle, lat: loc.lat, lon: loc.lon });
    if (ST.favorites.length > 8) ST.favorites = ST.favorites.slice(0, 8);
  }
  saveFavorites();
}

// ============================================================
// UTILITY
// ============================================================
function cToF(c) { return c == null ? null : (c * 9/5) + 32; }
function mpsToMph(v) { return v == null ? null : v * 2.23694; }
function kmhToMph(v) { return v == null ? null : v * 0.621371; }
function mmToIn(v) { return v == null ? null : v / 25.4; }
function round1(v) { return Math.round(v * 10) / 10; }
function paToInHg(pa) { return pa == null ? null : pa * 0.0002953; }

function tempColor(f) {
  if (f == null) return '#94a3b8';
  if (f >= 95) return '#ef4444';
  if (f >= 85) return '#f97316';
  if (f >= 75) return '#f59e0b';
  if (f >= 65) return '#84cc16';
  if (f >= 55) return '#22d3ee';
  if (f >= 45) return '#60a5fa';
  if (f >= 32) return '#818cf8';
  return '#c4b5fd';
}

function windDirArrow(deg) {
  if (deg == null) return '\u2013';
  const dirs = ['N','NE','E','SE','S','SW','W','NW'];
  return dirs[Math.round(deg / 45) % 8];
}

function skyEmoji(amount) {
  const m = { CLR:'\u2600\ufe0f', SKC:'\u2600\ufe0f', FEW:'\ud83c\udf24', SCT:'\u26c5', BKN:'\ud83c\udf25', OVC:'\u2601\ufe0f' };
  return m[amount] || '\ud83c\udf25';
}

function conditionIcon(sky, textDesc) {
  const desc = (textDesc || '').toLowerCase();
  if (desc.includes('thunder')) return '\u26c8\ufe0f';
  if (desc.includes('snow') || desc.includes('flurr')) return '\ud83c\udf28\ufe0f';
  if (desc.includes('freez') || desc.includes('ice') || desc.includes('sleet')) return '\ud83e\uddc2';
  if (desc.includes('rain') || desc.includes('shower') || desc.includes('drizzle')) return '\ud83c\udf27\ufe0f';
  if (desc.includes('fog') || desc.includes('mist')) return '\ud83c\udf2b\ufe0f';
  if (desc.includes('haze') || desc.includes('smoke')) return '\ud83c\udf2b\ufe0f';
  if (desc.includes('wind')) return '\ud83d\udca8';
  return skyEmoji(sky);
}

function wmoToPrecipType(code) {
  if (code == null) return 'none';
  if ([95,96,99].includes(code)) return 'tstm';
  if ([66,67,56,57].includes(code)) return 'frzr';
  if (code >= 71 && code <= 77) return 'snow';
  if ([85,86].includes(code)) return 'snow';
  if (code >= 61 && code <= 65) return 'rain';
  if (code >= 51 && code <= 55) return 'rain';
  if (code >= 80 && code <= 82) return 'rain';
  if (code >= 1 && code <= 3) return 'none';
  return 'none';
}

function precipTypeLabel(type) {
  return { rain:'\ud83d\udca7 Rain', snow:'\u2744\ufe0f Snow', frzr:'\ud83e\uddca Freezing Rain', mix:'\ud83c\udf00 Mix',
           tstm:'\u26c8 Thunder', none:'None' }[type] || 'None';
}
function precipTypeBadgeClass(type) {
  return { rain:'badge-rain', snow:'badge-snow', frzr:'badge-frzr',
           mix:'badge-mix', tstm:'badge-tstm', none:'badge-none' }[type] || 'badge-none';
}

function wmoDesc(code) {
  if (code == null) return '\u2014';
  const m = {
    0:'Clear', 1:'Mainly Clear', 2:'Partly Cloudy', 3:'Overcast',
    45:'Fog', 48:'Icy Fog',
    51:'Light Drizzle', 53:'Drizzle', 55:'Heavy Drizzle',
    56:'Lt Frz Drizzle', 57:'Hvy Frz Drizzle',
    61:'Light Rain', 63:'Rain', 65:'Heavy Rain',
    66:'Lt Frz Rain', 67:'Hvy Frz Rain',
    71:'Light Snow', 73:'Snow', 75:'Heavy Snow', 77:'Snow Grains',
    80:'Light Showers', 81:'Showers', 82:'Heavy Showers',
    85:'Snow Showers', 86:'Heavy Snow Showers',
    95:'Thunderstorm', 96:'Tstm + Hail', 99:'Tstm + Heavy Hail',
  };
  return m[code] || `Code ${code}`;
}

function fmtTime(iso) {
  const d = new Date(iso);
  const h = d.getHours();
  const ampm = h >= 12 ? 'PM' : 'AM';
  return `${h%12||12}${ampm}`;
}
function fmtTimeFull(iso) {
  const d = new Date(iso);
  return d.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', timeZoneName:'short' });
}

function fmtDay(iso) {
  const d = new Date(iso);
  const today = new Date();
  const tom = new Date(today); tom.setDate(today.getDate()+1);
  if (d.toDateString() === today.toDateString()) return 'Today';
  if (d.toDateString() === tom.toDateString()) return 'Tomorrow';
  return d.toLocaleDateString('en-US',{weekday:'short'});
}

function nwsIconUrl(url, size='small') {
  if (!url) return '';
  return url.replace(/\?size=\w+/, '') + '?size=' + size;
}

// ============================================================
// SEARCH / GEOCODING
// ============================================================
async function searchLocations(query) {
  const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=8&language=en&format=json`;
  try {
    const r = await fetch(url);
    if (!r.ok) return [];
    const data = await r.json();
    if (!data.results || !data.results.length) return [];
    return data.results
      .filter(item => item.country_code === 'US')
      .map(item => {
        const state = item.admin1 || '';
        const county = item.admin2 || '';
        const city = item.name || '';
        return {
          name: city,
          state,
          county,
          display: county ? `${city}, ${county}, ${state}` : `${city}, ${state}`,
          lat: item.latitude,
          lon: item.longitude,
          timezone: item.timezone || 'America/New_York',
        };
      });
  } catch(e) {
    console.warn('Geocoding failed:', e);
    return [];
  }
}

async function getNWSPointsForLocation(lat, lon) {
  const url = `https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`;
  const r = await fetch(url, { headers: { 'User-Agent': CFG.userAgent } });
  if (!r.ok) throw new Error(`NWS points failed (${r.status}) â€” location may be outside NWS coverage`);
  const d = await r.json();
  const p = d.properties;
  const city = p.relativeLocation?.properties?.city || '';
  const state = p.relativeLocation?.properties?.state || '';
  return {
    office: p.gridId,
    x: p.gridX,
    y: p.gridY,
    timezone: p.timeZone || 'America/New_York',
    nwsName: city && state ? `${city}, ${state}` : null,
  };
}

async function selectLocation(lat, lon, name, subtitle) {
  // Show loading
  document.getElementById('loading-text').textContent = `Loading forecast for ${name}\u2026`;
  document.getElementById('global-loading').classList.remove('hidden');
  document.getElementById('tab-forecast').classList.remove('active');

  try {
    const pts = await getNWSPointsForLocation(lat, lon);
    CFG.lat = lat;
    CFG.lon = lon;
    CFG.nwsOffice = pts.office;
    CFG.nwsX = pts.x;
    CFG.nwsY = pts.y;
    CFG.timezone = pts.timezone;
    CFG.locationName = name;
    CFG.locationSubtitle = subtitle || `${lat.toFixed(4)}\u00b0N ${Math.abs(lon).toFixed(4)}\u00b0${lon < 0 ? 'W' : 'E'}`;

    // Update page title and location display
    document.getElementById('page-title').textContent = `${name} \u2014 Weather`;
    document.getElementById('location-subtitle').textContent = CFG.locationSubtitle;
    document.getElementById('location-search').value = name;

    // Update snow location label
    const snowLbl = document.getElementById('snow-location-label');
    if (snowLbl) snowLbl.textContent = `${name} \u00b7 NWS gridded forecast`;

    // Update conditions map title
    const condTitle = document.getElementById('conditions-map-title');
    if (condTitle) condTitle.textContent = `Surface Observations \u00b7 Near ${name}`;
    const condLegend = document.getElementById('conditions-legend-text');
    if (condLegend) condLegend.textContent = `NWS ASOS stations near ${name}`;

    // Reset maps so they re-init for new location
    if (ST.maps.radar) {
      ST.maps.radar.setView([lat, lon], 7);
      if (ST._radarMarker) { ST._radarMarker.remove(); }
      ST._radarMarker = L.circleMarker([lat, lon], {
        radius: 8, color: '#4f7bff', fillColor: '#2563eb', fillOpacity: 0.85, weight: 2
      }).addTo(ST.maps.radar)
        .bindPopup(`<b style="color:#e2e8f0">${name}</b><br><span style="color:#94a3b8">${lat.toFixed(4)}\u00b0N ${Math.abs(lon).toFixed(4)}\u00b0W</span>`);
    }

    // Reset conditions map for new location
    if (ST.mapsInited.conditions && ST.maps.conditions) {
      ST.maps.conditions.setView([lat, lon], 7);
    }

    // Refresh all data
    await refreshAll();
  } catch(err) {
    console.error(err);
    document.getElementById('global-loading').classList.add('hidden');
    document.getElementById('tab-forecast').classList.add('active');
    document.getElementById('global-error').classList.remove('hidden');
    document.getElementById('error-text').textContent = err.message;
  }
}

// ============================================================
// SEARCH UI
// ============================================================
function showSearchDropdown(content) {
  const dd = document.getElementById('search-dropdown');
  dd.innerHTML = content;
  dd.classList.remove('hidden');
}
function hideSearchDropdown() {
  document.getElementById('search-dropdown').classList.add('hidden');
}

function buildFavoritesHTML() {
  if (!ST.favorites.length) return '';
  const items = ST.favorites.map(f => `
    <div class="sdrop-item" onclick="selectLocation(${f.lat}, ${f.lon}, ${JSON.stringify(f.name)}, ${JSON.stringify(f.subtitle || '')})">
      <span class="sdrop-item-icon">\u2b50</span>
      <div class="sdrop-item-text">
        <div class="sdrop-item-name">${f.name}</div>
        ${f.subtitle ? `<div class="sdrop-item-sub">${f.subtitle}</div>` : ''}
      </div>
      <button class="sdrop-fav-btn active" title="Remove favorite"
        onclick="event.stopPropagation(); removeFavoriteByName(${JSON.stringify(f.name)})">\u2605</button>
    </div>`).join('');
  return `<div class="sdrop-label">Favorites</div>${items}<div class="sdrop-divider"></div>`;
}

function removeFavoriteByName(name) {
  ST.favorites = ST.favorites.filter(f => f.name !== name);
  saveFavorites();
  // Re-render dropdown
  const inp = document.getElementById('location-search');
  const q = inp.value.trim();
  if (!q) showSearchDropdown(buildInitialDropdown());
}

function buildInitialDropdown() {
  const favHTML = buildFavoritesHTML();
  const geoBtn = `
    <div class="sdrop-divider"></div>
    <div class="sdrop-item" onclick="useCurrentLocation()">
      <span class="sdrop-item-icon">\ud83d\udccd</span>
      <div class="sdrop-item-text">
        <div class="sdrop-item-name">Use Current Location</div>
        <div class="sdrop-item-sub">Detect via browser GPS</div>
      </div>
    </div>`;
  const content = favHTML + geoBtn;
  return content;
}

function renderSearchResults(results) {
  if (!results.length) {
    return `<div class="sdrop-item" style="pointer-events:none">
      <span class="sdrop-item-icon">\ud83d\udd0d</span>
      <div class="sdrop-item-text"><div class="sdrop-item-name" style="color:#64748b">No results found</div></div>
    </div>`;
  }
  return results.map(r => {
    const fav = isFavorite(r.name);
    return `<div class="sdrop-item" onclick="selectLocation(${r.lat}, ${r.lon}, ${JSON.stringify(r.name)}, ${JSON.stringify(r.subtitle)})">
      <span class="sdrop-item-icon">\ud83d\udccd</span>
      <div class="sdrop-item-text">
        <div class="sdrop-item-name">${r.name}</div>
        ${r.subtitle ? `<div class="sdrop-item-sub">${r.subtitle}</div>` : ''}
      </div>
      <button class="sdrop-fav-btn ${fav ? 'active' : ''}" title="${fav ? 'Remove' : 'Add'} favorite"
        onclick="event.stopPropagation(); toggleFavoriteFromResult(${JSON.stringify(r)})">${fav ? '\u2605' : '\u2606'}</button>
    </div>`;
  }).join('');
}

function toggleFavoriteFromResult(r) {
  toggleFavorite(r);
  // Refresh results
  const q = document.getElementById('location-search').value.trim();
  if (q.length >= 2) {
    clearTimeout(ST.searchTimeout);
    doSearch(q);
  }
}

async function doSearch(q) {
  showSearchDropdown(`<div class="sdrop-item" style="pointer-events:none">
    <span class="sdrop-item-icon">\u23f3</span>
    <div class="sdrop-item-text"><div class="sdrop-item-name" style="color:#64748b">Searching\u2026</div></div>
  </div>`);
  try {
    const results = await searchLocations(q);
    showSearchDropdown(renderSearchResults(results));
  } catch(e) {
    showSearchDropdown(`<div class="sdrop-item" style="pointer-events:none">
      <span class="sdrop-item-icon">\u26a0\ufe0f</span>
      <div class="sdrop-item-text"><div class="sdrop-item-name" style="color:#ef4444">Search failed</div></div>
    </div>`);
  }
}

async function useCurrentLocation() {
  hideSearchDropdown();
  if (!navigator.geolocation) {
    alert('Geolocation not supported by your browser.');
    return;
  }
  document.getElementById('location-search').value = 'Detecting location\u2026';
  navigator.geolocation.getCurrentPosition(
    async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      // Reverse geocode with Open-Meteo
      try {
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`);
        const d = await r.json();
        const result = d.results && d.results[0];
        const city = result ? (result.name || 'Your Location') : 'Your Location';
        const state = result ? (result.admin1 || '') : '';
        const county = result ? (result.admin2 || '') : '';
        const name = state ? `${city}, ${state}` : city;
        const subtitle = `${lat.toFixed(4)}\u00b0N ${Math.abs(lon).toFixed(4)}\u00b0W${county ? ' \u00b7 ' + county : ''}`;
        if (result && result.timezone) CFG.timezone = result.timezone;
        await selectLocation(lat, lon, name, subtitle);
      } catch(e) {
        const name = `${lat.toFixed(3)}\u00b0N, ${Math.abs(lon).toFixed(3)}\u00b0W`;
        await selectLocation(lat, lon, name, `${lat.toFixed(4)}\u00b0N ${Math.abs(lon).toFixed(4)}\u00b0W`);
      }
    },
    err => {
      document.getElementById('location-search').value = CFG.locationName;
      alert('Could not get location: ' + err.message);
    },
    { timeout: 10000 }
  );
}

function initSearch() {
  loadFavorites();
  const inp = document.getElementById('location-search');
  inp.value = CFG.locationName;

  inp.addEventListener('focus', () => {
    const q = inp.value.trim();
    if (!q || q === CFG.locationName) {
      showSearchDropdown(buildInitialDropdown());
    }
  });

  inp.addEventListener('input', () => {
    clearTimeout(ST.searchTimeout);
    const q = inp.value.trim();
    if (!q) {
      showSearchDropdown(buildInitialDropdown());
      return;
    }
    if (q.length < 2) return;
    ST.searchTimeout = setTimeout(() => doSearch(q), 320);
  });

  inp.addEventListener('keydown', e => {
    if (e.key === 'Escape') { hideSearchDropdown(); inp.blur(); }
  });

  document.addEventListener('click', e => {
    if (!document.getElementById('search-wrap').contains(e.target)) {
      hideSearchDropdown();
      inp.value = CFG.locationName;
    }
  });
}

// ============================================================
// MODAL
// ============================================================
function openModal(eyebrow, title, subtitle, bodyHTML) {
  document.getElementById('modal-eyebrow').textContent = eyebrow;
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-subtitle').textContent = subtitle;
  document.getElementById('modal-body').innerHTML = bodyHTML;
  document.getElementById('detail-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal() {
  document.getElementById('detail-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function detailItem(label, value, wide) {
  if (!value && value !== 0) return '';
  return `<div class="mdetail-item" style="${wide ? 'grid-column:1/-1' : ''}">
    <div class="mdetail-lbl">${label}</div>
    <div class="mdetail-val">${value}</div>
  </div>`;
}

// ============================================================
// FORECAST DETAIL MODALS
// ============================================================
function showDailyDetail(period, omHourly) {
  const tc = tempColor(period.temperature);
  const pop = period.probabilityOfPrecipitation?.value ?? null;
  const dewF = period.dewpoint?.value != null ? Math.round(cToF(period.dewpoint.value)) : null;
  const rh = period.relativeHumidity?.value != null ? Math.round(period.relativeHumidity.value) : null;
  const icon = nwsIconUrl(period.icon, 'large');

  // Find matching OM data for this period start hour
  let feelsLike = null, visibility = null, cloudCover = null, precip = null, snowfall = null;
  if (omHourly) {
    const key = period.startTime.slice(0, 13);
    const idx = omHourly.time.findIndex(t => t.slice(0,13) === key);
    if (idx >= 0) {
      feelsLike = omHourly.apparent_temperature ? Math.round(omHourly.apparent_temperature[idx]) : null;
      visibility = omHourly.visibility ? Math.round(omHourly.visibility[idx] * 0.000621371 * 10) / 10 : null;
      cloudCover = omHourly.cloud_cover ? omHourly.cloud_cover[idx] : null;
      precip = omHourly.precipitation ? omHourly.precipitation[idx] : null;
      snowfall = omHourly.snowfall ? omHourly.snowfall[idx] : null;
    }
  }

  const body = `
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px">
      ${icon ? `<img src="${icon}" alt="${period.shortForecast}" style="width:64px;height:64px;border-radius:12px" />` : ''}
      <div>
        <div style="font-size:2rem;font-weight:900;color:${tc}">${period.temperature}\u00b0${period.temperatureUnit}</div>
        <div style="font-size:0.875rem;color:#94a3b8">${period.shortForecast}</div>
      </div>
    </div>
    <div class="mdetail-grid">
      ${detailItem('Wind', `${period.windSpeed} ${period.windDirection}`)}
      ${pop != null ? detailItem('Precip Chance', `${pop}%`) : ''}
      ${dewF != null ? detailItem('Dew Point', `${dewF}\u00b0F`) : ''}
      ${rh != null ? detailItem('Humidity', `${rh}%`) : ''}
      ${feelsLike != null ? detailItem('Feels Like', `${feelsLike}\u00b0F`) : ''}
      ${cloudCover != null ? detailItem('Cloud Cover', `${cloudCover}%`) : ''}
      ${visibility != null ? detailItem('Visibility', `${visibility} mi`) : ''}
      ${precip != null && precip > 0 ? detailItem('Precipitation', `${precip.toFixed(2)}"`) : ''}
      ${snowfall != null && snowfall > 0 ? detailItem('Snowfall', `${snowfall.toFixed(2)}"`) : ''}
      ${period.temperatureTrend ? detailItem('Temp Trend', period.temperatureTrend) : ''}
    </div>
    ${period.detailedForecast ? `<div class="mdetail-desc">${period.detailedForecast}</div>` : ''}`;

  openModal(
    period.isDaytime ? '\u2600\ufe0f Daytime Forecast' : '\ud83c\udf1a Nighttime Forecast',
    period.name,
    new Date(period.startTime).toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' }),
    body
  );
}

function showHourlyDetail(period, omHourly) {
  const tc = tempColor(period.temperature);
  const pop = period.probabilityOfPrecipitation?.value ?? null;
  const dewF = period.dewpoint?.value != null ? Math.round(cToF(period.dewpoint.value)) : null;
  const rh = period.relativeHumidity?.value != null ? Math.round(period.relativeHumidity.value) : null;
  const icon = nwsIconUrl(period.icon, 'medium');

  // Open-Meteo data for the same hour
  let feelsLike = null, visibility = null, cloudCover = null, precip = null;
  let snow = null, rain = null, cape = null, ptype = null;
  if (omHourly) {
    const key = period.startTime.slice(0, 13);
    const idx = omHourly.time.findIndex(t => t.slice(0,13) === key);
    if (idx >= 0) {
      feelsLike = omHourly.apparent_temperature ? Math.round(omHourly.apparent_temperature[idx]) : null;
      visibility = omHourly.visibility ? Math.round(omHourly.visibility[idx] * 0.000621371 * 10) / 10 : null;
      cloudCover = omHourly.cloud_cover ? omHourly.cloud_cover[idx] : null;
      precip = omHourly.precipitation ? omHourly.precipitation[idx] : null;
      snow = omHourly.snowfall ? omHourly.snowfall[idx] : null;
      rain = omHourly.rain ? omHourly.rain[idx] : null;
      cape = omHourly.cape ? omHourly.cape[idx] : null;
      const code = omHourly.weather_code ? omHourly.weather_code[idx] : null;
      ptype = code != null ? wmoToPrecipType(code) : null;
    }
  }

  const body = `
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px">
      ${icon ? `<img src="${icon}" alt="${period.shortForecast}" style="width:56px;height:56px;border-radius:10px" />` : ''}
      <div>
        <div style="font-size:2rem;font-weight:900;color:${tc}">${period.temperature}\u00b0${period.temperatureUnit}</div>
        <div style="font-size:0.875rem;color:#94a3b8">${period.shortForecast}</div>
      </div>
    </div>
    <div class="mdetail-grid">
      ${detailItem('Wind', `${period.windSpeed} ${period.windDirection}`)}
      ${pop != null ? detailItem('Precip Chance', `${pop}%`) : ''}
      ${feelsLike != null ? detailItem('Feels Like', `${feelsLike}\u00b0F`) : ''}
      ${dewF != null ? detailItem('Dew Point', `${dewF}\u00b0F`) : ''}
      ${rh != null ? detailItem('Humidity', `${rh}%`) : ''}
      ${cloudCover != null ? detailItem('Cloud Cover', `${cloudCover}%`) : ''}
      ${visibility != null ? detailItem('Visibility', `${visibility} mi`) : ''}
      ${precip != null && precip > 0 ? detailItem('Precipitation', `${precip.toFixed(3)}"`) : ''}
      ${rain != null && rain > 0 ? detailItem('Rain', `${rain.toFixed(3)}"`) : ''}
      ${snow != null && snow > 0 ? detailItem('Snowfall', `${snow.toFixed(3)}"`) : ''}
      ${cape != null && cape > 0 ? detailItem('CAPE', `${Math.round(cape)} J/kg`) : ''}
      ${ptype && ptype !== 'none' ? detailItem('Precip Type', precipTypeLabel(ptype)) : ''}
    </div>`;

  const startDt = new Date(period.startTime);
  openModal(
    '\u23f1\ufe0f Hourly Forecast',
    fmtTimeFull(period.startTime),
    startDt.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' }),
    body
  );
}

// ============================================================
// STATION DETAIL MODAL
// ============================================================
async function showStationDetail(stationId) {
  openModal('\ud83d\udccd Weather Station', stationId, 'Loading latest observation\u2026', `
    <div style="display:flex;justify-content:center;padding:24px">
      <div class="spinner"></div>
    </div>`);

  try {
    const r = await fetch(`https://api.weather.gov/stations/${stationId}/observations/latest`, {
      headers: { 'User-Agent': CFG.userAgent }
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    const p = data.properties;
    const obs = p || {};

    const tempF = obs.temperature?.value != null ? Math.round(cToF(obs.temperature.value)) : null;
    const dewF = obs.dewpoint?.value != null ? Math.round(cToF(obs.dewpoint.value)) : null;
    const tc = tempColor(tempF);
    const windKmh = obs.windSpeed?.value ?? null;
    const windMph = windKmh != null ? Math.round(windKmh * 0.621371) : null;
    const windGustKmh = obs.windGust?.value ?? null;
    const windGustMph = windGustKmh != null ? Math.round(windGustKmh * 0.621371) : null;
    const windDir = obs.windDirection?.value ?? null;
    const rh = obs.relativeHumidity?.value != null ? Math.round(obs.relativeHumidity.value) : null;
    const baroInHg = obs.barometricPressure?.value != null ? (obs.barometricPressure.value * 0.0002953).toFixed(2) : null;
    const slpInHg = obs.seaLevelPressure?.value != null ? (obs.seaLevelPressure.value * 0.0002953).toFixed(2) : null;
    const visM = obs.visibility?.value ?? null;
    const visMi = visM != null ? (visM * 0.000621371).toFixed(1) : null;
    const maxTF = obs.maxTemperatureLast24Hours?.value != null ? Math.round(cToF(obs.maxTemperatureLast24Hours.value)) : null;
    const minTF = obs.minTemperatureLast24Hours?.value != null ? Math.round(cToF(obs.minTemperatureLast24Hours.value)) : null;
    const precip6h = obs.precipitationLast6Hours?.value != null ? (obs.precipitationLast6Hours.value * 0.0393701).toFixed(2) : null;
    const precip3h = obs.precipitationLast3Hours?.value != null ? (obs.precipitationLast3Hours.value * 0.0393701).toFixed(2) : null;
    const precip1h = obs.precipitationLast1Hour?.value != null ? (obs.precipitationLast1Hour.value * 0.0393701).toFixed(2) : null;
    const windChillF = obs.windChill?.value != null ? Math.round(cToF(obs.windChill.value)) : null;
    const heatIdxF = obs.heatIndex?.value != null ? Math.round(cToF(obs.heatIndex.value)) : null;

    const clouds = (obs.cloudLayers || []).map(cl =>
      `${cl.amount || ''}${cl.base?.value != null ? ' @ '+Math.round(cl.base.value*3.28084)+' ft' : ''}`
    ).filter(Boolean).join(', ');

    const wx = (obs.presentWeather || []).map(w => w.rawString || '').filter(Boolean).join(', ');

    const obsTime = obs.timestamp ? new Date(obs.timestamp).toLocaleString('en-US', {
      month:'short', day:'numeric', hour:'numeric', minute:'2-digit', timeZoneName:'short'
    }) : null;

    const stName = (obs.station || stationId);

    document.getElementById('modal-subtitle').textContent = obsTime ? `Observed: ${obsTime}` : '';
    document.getElementById('modal-title').textContent = obs.textDescription || 'Station Observation';

    const body = `
      ${tempF != null ? `<div style="text-align:center;margin-bottom:14px">
        <div style="font-size:2.5rem;font-weight:900;color:${tc}">${tempF}\u00b0F</div>
        ${obs.textDescription ? `<div style="color:#94a3b8;font-size:0.9rem">${obs.textDescription}</div>` : ''}
      </div>` : ''}
      <div class="mdetail-grid">
        ${dewF != null ? detailItem('Dew Point', `${dewF}\u00b0F`) : ''}
        ${rh != null ? detailItem('Humidity', `${rh}%`) : ''}
        ${windMph != null ? detailItem('Wind', `${windMph} mph ${windDirArrow(windDir)}${windDir != null ? ' ('+Math.round(windDir)+'\u00b0)' : ''}`) : ''}
        ${windGustMph != null ? detailItem('Wind Gust', `${windGustMph} mph`) : ''}
        ${windChillF != null ? detailItem('Wind Chill', `${windChillF}\u00b0F`) : ''}
        ${heatIdxF != null ? detailItem('Heat Index', `${heatIdxF}\u00b0F`) : ''}
        ${baroInHg != null ? detailItem('Pressure (Sfc)', `${baroInHg} inHg`) : ''}
        ${slpInHg != null ? detailItem('Sea Level Pres.', `${slpInHg} inHg`) : ''}
        ${visMi != null ? detailItem('Visibility', `${visMi} mi`) : ''}
        ${clouds ? detailItem('Cloud Layers', clouds, true) : ''}
        ${wx ? detailItem('Present Weather', wx, true) : ''}
        ${maxTF != null ? detailItem('24h High', `${maxTF}\u00b0F`) : ''}
        ${minTF != null ? detailItem('24h Low', `${minTF}\u00b0F`) : ''}
        ${precip1h != null ? detailItem('Precip (1h)', `${precip1h}"`) : ''}
        ${precip3h != null ? detailItem('Precip (3h)', `${precip3h}"`) : ''}
        ${precip6h != null ? detailItem('Precip (6h)', `${precip6h}"`) : ''}
      </div>
      <div class="mdetail-desc" style="margin-top:12px;font-size:0.78rem;color:#64748b">
        Station ID: ${stationId} \u00b7 Source: NWS ASOS
      </div>`;

    document.getElementById('modal-body').innerHTML = body;
    document.getElementById('modal-eyebrow').textContent = '\ud83d\udccd Weather Station \u2014 ' + stationId;
  } catch(err) {
    document.getElementById('modal-body').innerHTML = `
      <p style="color:#ef4444;text-align:center;padding:20px">\u26a0\ufe0f Could not load observation: ${err.message}</p>`;
  }
}

// ============================================================
// API FETCHING
// ============================================================
async function fetchNWSForecast() {
  const url = `https://api.weather.gov/gridpoints/${CFG.nwsOffice}/${CFG.nwsX},${CFG.nwsY}/forecast`;
  const r = await fetch(url, { headers:{'User-Agent': CFG.userAgent} });
  if (!r.ok) throw new Error(`NWS forecast: ${r.status}`);
  const d = await r.json();
  return d.properties.periods;
}

async function fetchNWSHourly() {
  const url = `https://api.weather.gov/gridpoints/${CFG.nwsOffice}/${CFG.nwsX},${CFG.nwsY}/forecast/hourly`;
  const r = await fetch(url, { headers:{'User-Agent': CFG.userAgent} });
  if (!r.ok) throw new Error(`NWS hourly: ${r.status}`);
  const d = await r.json();
  return d.properties.periods;
}

async function fetchOpenMeteo() {
  const params = new URLSearchParams({
    latitude: CFG.lat,
    longitude: CFG.lon,
    current: 'temperature_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,relative_humidity_2m,cloud_cover,precipitation,surface_pressure',
    hourly: 'temperature_2m,apparent_temperature,weather_code,precipitation,rain,snowfall,cloud_cover,wind_speed_10m,wind_direction_10m,visibility,cape,dew_point_2m,surface_pressure',
    temperature_unit: 'fahrenheit',
    wind_speed_unit: 'mph',
    precipitation_unit: 'inch',
    timezone: CFG.timezone || 'America/New_York',
    forecast_days: 7,
  });
  const r = await fetch(`https://api.open-meteo.com/v1/forecast?${params}`);
  if (!r.ok) throw new Error(`Open-Meteo: ${r.status}`);
  return r.json();
}

async function fetchNWSSnowfall() {
  try {
    const url = `https://api.weather.gov/gridpoints/${CFG.nwsOffice}/${CFG.nwsX},${CFG.nwsY}`;
    const r = await fetch(url, { headers:{'User-Agent': CFG.userAgent} });
    if (!r.ok) return null;
    const d = await r.json();
    return d.properties.snowfallAmount?.values || null;
  } catch(e) { return null; }
}

async function fetchStations() {
  const url = `https://api.weather.gov/gridpoints/${CFG.nwsOffice}/${CFG.nwsX},${CFG.nwsY}/stations`;
  const r = await fetch(url, { headers:{'User-Agent': CFG.userAgent} });
  if (!r.ok) return [];
  const d = await r.json();
  const features = (d.features || []).slice(0, 25);

  const results = await Promise.allSettled(
    features.map(f =>
      fetch(`${f.id}/observations/latest`, { headers:{'User-Agent': CFG.userAgent} })
        .then(res => res.ok ? res.json() : null)
        .catch(() => null)
    )
  );

  return results.map((res, i) => {
    if (res.status !== 'fulfilled' || !res.value) return null;
    const obs = res.value;
    const p = obs.properties;
    const f = features[i];
    if (!p || p.temperature?.value == null) return null;
    const windKmh = p.windSpeed?.value ?? null;
    return {
      id: f.properties.stationIdentifier,
      name: f.properties.name,
      lat: f.geometry.coordinates[1],
      lon: f.geometry.coordinates[0],
      tempF: cToF(p.temperature.value),
      windMph: windKmh != null ? windKmh * 0.621371 : null,
      windDir: p.windDirection?.value ?? null,
      humidity: p.relativeHumidity?.value ?? null,
      sky: p.cloudLayers?.[0]?.amount ?? 'CLR',
      textDescription: p.textDescription ?? '\u2014',
      timestamp: p.timestamp,
    };
  }).filter(Boolean);
}

// ============================================================
// RENDER HEADER
// ============================================================
function renderHeader(om) {
  const c = om.current;
  const tempF = c.temperature_2m;
  const ptype = wmoToPrecipType(c.weather_code);
  const desc = wmoDesc(c.weather_code);

  document.getElementById('hdr-temp').textContent = `${Math.round(tempF)}\u00b0F`;
  document.getElementById('hdr-temp').style.color = tempColor(tempF);
  document.getElementById('hdr-desc').textContent = desc;
  document.getElementById('stat-feels').textContent = `${Math.round(c.apparent_temperature)}\u00b0F`;
  document.getElementById('stat-wind').textContent =
    `${Math.round(c.wind_speed_10m)} mph ${windDirArrow(c.wind_direction_10m)}`;
  document.getElementById('stat-humid').textContent = `${Math.round(c.relative_humidity_2m)}%`;
  document.getElementById('stat-cloud').textContent = `${Math.round(c.cloud_cover)}%`;

  const ptEl = document.getElementById('stat-ptype');
  ptEl.textContent = precipTypeLabel(ptype);
  ptEl.className = `text-sm font-bold px-2 py-0.5 rounded-full ${precipTypeBadgeClass(ptype)}`;

  // Visibility: first hourly value, cap at 10mi
  const h = om.hourly;
  const nowIdx = h ? h.time.findIndex(t => new Date(t) >= new Date()) : -1;
  const visM = h && h.visibility && nowIdx >= 0 ? h.visibility[nowIdx] : null;
  const visMi = visM != null ? Math.min(10, Math.round(visM * 0.000621371 * 10) / 10) : null;
  const visEl = document.getElementById('stat-vis');
  if (visEl) visEl.textContent = visMi != null ? `${visMi} mi` : '--';

  // Pressure: current surface_pressure hPa -> inHg
  const pressHpa = c.surface_pressure != null ? c.surface_pressure : null;
  const pressInHg = pressHpa != null ? Math.round(pressHpa * 0.02953 * 100) / 100 : null;
  const pressEl = document.getElementById('stat-pressure');
  if (pressEl) pressEl.textContent = pressInHg != null ? `${pressInHg} inHg` : '--';

  const now = new Date();
  const upd = now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  document.getElementById('stat-updated').textContent = upd;
  document.getElementById('footer-updated').textContent = `Updated ${upd}`;
}

// ============================================================
// WEATHER ICON HELPERS
// ============================================================
function getWeatherIcon(wmoCode, isDaytime) {
  const c = wmoCode;
  if (c === 0) return isDaytime ? '&#9728;&#65039;' : '&#127769;';
  if (c <= 2) return isDaytime ? '&#9925;' : '&#127769;';
  if (c === 3) return '&#9729;&#65039;';
  if (c <= 49) return '&#127787;&#65039;';
  if (c <= 59) return '&#127746;&#65039;';
  if (c <= 67) return '&#127751;&#65039;';
  if (c <= 69) return '&#129514;';
  if (c <= 77) return '&#127752;&#65039;';
  if (c <= 82) return '&#127751;&#65039;';
  if (c <= 86) return '&#127752;&#65039;';
  if (c <= 99) return '&#9889;';
  return isDaytime ? '&#9728;&#65039;' : '&#127769;';
}

function getIconFromForecast(shortForecast, isDaytime) {
  const f = (shortForecast || '').toLowerCase();
  if (/thunder|tstm/.test(f)) return '&#9889;';
  if (/blizzard/.test(f)) return '&#127781;&#65039;';
  if (/ice|sleet|freez/.test(f)) return '&#129514;';
  if (/snow|flurr/.test(f)) return '&#127752;&#65039;';
  if (/drizzle/.test(f)) return '&#127746;&#65039;';
  if (/shower|rain/.test(f)) return '&#127751;&#65039;';
  if (/fog|mist|haz/.test(f)) return '&#127787;&#65039;';
  if (/wind/.test(f)) return '&#128168;';
  if (/overcast/.test(f)) return '&#9729;&#65039;';
  if (/mostly cloudy|cloudy/.test(f)) return '&#9729;&#65039;';
  if (/partly/.test(f)) return isDaytime ? '&#9925;' : '&#127764;&#65039;';
  if (/mostly clear|mostly sunny/.test(f)) return isDaytime ? '&#9728;&#65039;' : '&#127769;';
  if (/clear|sunny/.test(f)) return isDaytime ? '&#9728;&#65039;' : '&#127769;';
  return isDaytime ? '&#9728;&#65039;' : '&#127769;';
}

// ============================================================
// RENDER 7-DAY FORECAST (clickable)
// ============================================================
function renderDailyForecast(periods) {
  const days = [];
  let i = 0;
  while (i < periods.length && days.length < 7) {
    const p = periods[i];
    if (p.isDaytime) {
      const night = periods[i+1];
      days.push({ day: p, night });
      i += 2;
    } else {
      days.push({ day: null, night: p });
      i++;
    }
  }

  const grid = document.getElementById('daily-grid');
  grid.innerHTML = days.map((pair, idx) => {
    const main = pair.day || pair.night;
    const dayLabel = idx === 0 ? 'Today' : fmtDay(main.startTime);
    const hiTemp = pair.day?.temperature ?? '\u2014';
    const loTemp = pair.night?.temperature ?? '\u2014';
    const hiColor = tempColor(pair.day?.temperature);
    const loColor = tempColor(pair.night?.temperature);
    const wxIcon = getIconFromForecast(main.shortForecast, main.isDaytime !== false);
    const pop = main.probabilityOfPrecipitation?.value ?? 0;
    const pidx = idx;

    return `<div class="day-card fade-up" style="animation-delay:${idx*0.04}s"
        onclick="showDailyDetail(ST.nwsForecast[${pidx*2 + (days[pidx]?.day ? 0 : 0)}], ST.openMeteo?.hourly)">
      <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">${dayLabel}</p>
      <div class="wx-ico w-14 h-14 my-2">${wxIcon}</div>
      <div class="flex gap-2 items-baseline">
        <span class="text-xl font-extrabold" style="color:${hiColor}">${hiTemp}\u00b0</span>
        ${loTemp !== '\u2014' ? `<span class="text-sm font-semibold" style="color:${loColor}">${loTemp}\u00b0</span>` : ''}
      </div>
      <p class="text-xs text-slate-400 mt-1 leading-tight">${main.shortForecast}</p>
      ${pop > 0 ? `<p class="text-xs mt-1 text-cyan-400 font-semibold">\ud83d\udca7 ${pop}%</p>` : ''}
    </div>`;
  }).join('');
}

// ============================================================
// RENDER HOURLY SCROLL (clickable)
// ============================================================
function renderHourlyScroll(periods, omHourly) {
  const next48 = periods.slice(0, 48);

  const omLookup = {};
  if (omHourly) {
    omHourly.time.forEach((t, idx) => {
      const key = t.slice(0, 13);
      omLookup[key] = {
        ptype: wmoToPrecipType(omHourly.weather_code[idx]),
        precip: omHourly.precipitation[idx],
      };
    });
  }

  const container = document.getElementById('hourly-scroll');
  container.innerHTML = next48.map((p, idx) => {
    const time = fmtTime(p.startTime);
    const tempF = p.temperature;
    const tc = tempColor(tempF);
    const pop = p.probabilityOfPrecipitation?.value ?? 0;
    const wxIcon = getIconFromForecast(p.shortForecast, p.isDaytime !== false);
    const omKey = p.startTime.slice(0, 13);
    const om = omLookup[omKey] || {};
    const ptype = om.ptype || 'none';
    const badgeCls = precipTypeBadgeClass(ptype);
    const ptLabel = ptype !== 'none' ? precipTypeLabel(ptype) : '';

    return `<div class="hourly-card fade-up" style="animation-delay:${Math.min(idx,12)*0.02}s"
        onclick="showHourlyDetail(ST.nwsHourly[${idx}], ST.openMeteo?.hourly)">
      <p class="text-xs font-bold text-slate-400">${time}</p>
      <div class="wx-ico w-10 h-10" style="font-size:20px">${wxIcon}</div>
      <p class="text-base font-extrabold" style="color:${tc}">${tempF}\u00b0</p>
      ${pop > 0 ? `<p class="text-xs text-cyan-400 font-semibold">${pop}%</p>` : ''}
      ${ptLabel ? `<span class="text-xs px-1.5 py-0.5 rounded-full ${badgeCls} leading-tight">${ptLabel}</span>` : ''}
    </div>`;
  }).join('');
}

// ============================================================
// RENDER CHART (Chart.js \u2013 48h temp + precip)
// ============================================================
function renderTempChart(om) {
  const ctx = document.getElementById('chart-temp');
  if (!ctx || !om) return;
  if (ST.tempChart) { ST.tempChart.destroy(); ST.tempChart = null; }
  const h = om.hourly;
  const slice = 48;
  const labels = h.time.slice(0, slice).map(t => {
    const d = new Date(t);
    return d.getHours() === 0
      ? d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})
      : fmtTime(t);
  });
  const temps = h.temperature_2m.slice(0, slice);
  const feels = h.apparent_temperature.slice(0, slice);
  ST.tempChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Temp (F)', data: temps, borderColor: 'rgba(249,115,22,0.9)', backgroundColor: 'rgba(249,115,22,0.08)', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true },
        { label: 'Feels Like (F)', data: feels, borderColor: 'rgba(139,92,246,0.7)', backgroundColor: 'rgba(139,92,246,0.04)', borderWidth: 1.5, pointRadius: 0, tension: 0.4, borderDash: [4,3] },
      ],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { family: 'Inter', size: 11 } } },
        tooltip: { backgroundColor: 'rgba(8,12,35,0.92)', borderColor: 'rgba(99,131,255,0.25)', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#94a3b8', padding: 10,
          callbacks: { label: ctx => ` ${Math.round(ctx.parsed.y)}F` } },
      },
      scales: {
        x: { ticks: { color: '#475569', font: { size: 10 }, maxRotation: 0, maxTicksLimit: 12 }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { ticks: { color: '#f97316', font: { size: 11 }, callback: v => v + 'F' }, grid: { color: 'rgba(255,255,255,0.04)' } },
      },
    },
  });
}

function renderWindChart(om) {
  const ctx = document.getElementById('chart-wind');
  if (!ctx || !om) return;
  if (ST.windChart) { ST.windChart.destroy(); ST.windChart = null; }
  const h = om.hourly;
  const slice = 48;
  const labels = h.time.slice(0, slice).map(t => {
    const d = new Date(t);
    return d.getHours() === 0
      ? d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})
      : fmtTime(t);
  });
  const winds = h.wind_speed_10m.slice(0, slice);
  ST.windChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Wind (mph)', data: winds, borderColor: 'rgba(6,182,212,0.9)', backgroundColor: 'rgba(6,182,212,0.08)', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true },
      ],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { family: 'Inter', size: 11 } } },
        tooltip: { backgroundColor: 'rgba(8,12,35,0.92)', borderColor: 'rgba(99,131,255,0.25)', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#94a3b8', padding: 10 },
      },
      scales: {
        x: { ticks: { color: '#475569', font: { size: 10 }, maxRotation: 0, maxTicksLimit: 12 }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { min: 0, ticks: { color: '#22d3ee', font: { size: 11 }, callback: v => v + 'mph' }, grid: { color: 'rgba(255,255,255,0.04)' } },
      },
    },
  });
}

function renderPressureChart(om) {
  const ctx = document.getElementById('chart-pressure');
  if (!ctx || !om) return;
  if (ST.pressChart) { ST.pressChart.destroy(); ST.pressChart = null; }
  const h = om.hourly;
  if (!h.surface_pressure) return;
  const slice = 48;
  const labels = h.time.slice(0, slice).map(t => {
    const d = new Date(t);
    return d.getHours() === 0
      ? d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})
      : fmtTime(t);
  });
  const press = h.surface_pressure.slice(0, slice).map(v => v != null ? Math.round(v * 0.02953 * 100) / 100 : null);
  ST.pressChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Pressure (inHg)', data: press, borderColor: 'rgba(99,131,255,0.9)', backgroundColor: 'rgba(99,131,255,0.08)', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true },
      ],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { family: 'Inter', size: 11 } } },
        tooltip: { backgroundColor: 'rgba(8,12,35,0.92)', borderColor: 'rgba(99,131,255,0.25)', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#94a3b8', padding: 10,
          callbacks: { label: ctx => ` ${ctx.parsed.y}"` } },
      },
      scales: {
        x: { ticks: { color: '#475569', font: { size: 10 }, maxRotation: 0, maxTicksLimit: 12 }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { ticks: { color: '#6385ff', font: { size: 11 }, callback: v => v + '"' }, grid: { color: 'rgba(255,255,255,0.04)' } },
      },
    },
  });
}

// ============================================================
// SNOWFALL FORECAST CHART (NWS gridded)
// ============================================================
function parseISO8601DurationHours(dur) {
  const m = dur.match(/PT(\d+)H/);
  return m ? parseInt(m[1]) : 6;
}

function renderSnowfallChart(values) {
  const ctx = document.getElementById('snow-forecast-chart');
  if (!ctx) return;
  if (ST.snowChart) { ST.snowChart.destroy(); ST.snowChart = null; }

  if (!values || !values.length) {
    ctx.closest('.snow-chart-wrap').innerHTML = '<p class="text-xs text-slate-500 text-center pt-8">No snowfall forecast data available for this location.</p>';
    return;
  }

  const now = new Date();
  const future = values.filter(v => new Date(v.validTime.split('/')[0]) >= now).slice(0, 28);

  if (!future.length) {
    ctx.closest('.snow-chart-wrap').innerHTML = '<p class="text-xs text-slate-500 text-center pt-8">No upcoming snowfall forecast.</p>';
    return;
  }

  const labels = future.map(v => {
    const d = new Date(v.validTime.split('/')[0]);
    const h = d.getHours();
    return h === 0
      ? d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' })
      : fmtTime(v.validTime.split('/')[0]);
  });
  // NWS returns meters (wmoUnit:m) \u2014 convert to inches
  const amounts = future.map(v => {
    const meters = v.value ?? 0;
    return Math.max(0, parseFloat((meters * 39.3701).toFixed(2)));
  });

  const hasSnow = amounts.some(a => a > 0);
  const barColors = amounts.map(a => a > 0 ? 'rgba(148,163,184,0.75)' : 'rgba(71,85,105,0.2)');

  ST.snowChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Snowfall (in)',
        data: amounts,
        backgroundColor: barColors,
        borderRadius: 4,
      }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(8,12,35,0.92)', borderColor: 'rgba(99,131,255,0.25)',
          borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#94a3b8', padding: 10,
          callbacks: {
            label: ctx => ` ${ctx.parsed.y.toFixed(2)}" snowfall`,
          },
        },
      },
      scales: {
        x: { ticks: { color: '#475569', font: { size: 10 }, maxRotation: 0, maxTicksLimit: 12 }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { min: 0, ticks: { color: '#cbd5e1', font: { size: 10 }, callback: v => `${v}"` }, grid: { color: 'rgba(255,255,255,0.04)' } },
      },
    },
  });

  if (!hasSnow) {
    const wrap = ctx.closest('.snow-chart-wrap');
    const note = document.createElement('p');
    note.className = 'text-xs text-slate-500 text-center mt-1';
    note.textContent = 'No significant snowfall forecast in the next 7 days.';
    wrap.after(note);
  }
}

// ============================================================
// RADAR MAP
// ============================================================
// ============================================================
// RAINVIEWER RADAR
// ============================================================
let RV = { frames: [], host: '', currentIdx: 9, playing: false, playTimer: null, layer: null };

async function fetchRainViewerFrames() {
  try {
    const r = await fetch('https://api.rainviewer.com/public/weather-maps.json');
    const data = await r.json();
    RV.host = data.host;
    RV.frames = (data.radar && data.radar.past ? data.radar.past : []).slice(-10);
    return true;
  } catch(e) {
    console.warn('RainViewer fetch failed:', e);
    return false;
  }
}

function initRadarMap() {
  if (ST.mapsInited.radar) return;
  ST.mapsInited.radar = true;

  const map = L.map('radar-map', { center: [CFG.lat, CFG.lon], zoom: 7, zoomControl: true });
  ST.maps.radar = map;

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
    subdomains: 'abcd', maxZoom: 19,
  }).addTo(map);

  L.circleMarker([CFG.lat, CFG.lon], {
    radius: 8, color: '#4f7bff', fillColor: '#2563eb', fillOpacity: 0.85, weight: 2
  }).addTo(map).bindPopup('<b style="color:#e2e8f0">' + CFG.locationName + '</b>');

  fetchRainViewerFrames().then(ok => {
    if (ok && RV.frames.length) {
      RV.currentIdx = RV.frames.length - 1;
      setRainViewerFrame(RV.currentIdx);
      updateRVSlider();
      updateRVTicks();
    }
  });
}

function setRainViewerFrame(idx) {
  if (!RV.frames.length || !ST.maps.radar) return;
  idx = Math.max(0, Math.min(RV.frames.length - 1, idx));
  RV.currentIdx = idx;
  const frame = RV.frames[idx];
  if (RV.layer) ST.maps.radar.removeLayer(RV.layer);
  RV.layer = L.tileLayer(
    RV.host + frame.path + '/256/{z}/{x}/{y}/2/1_1.png',
    { opacity: 0.75, attribution: 'RainViewer', maxZoom: 19, tileSize: 256 }
  ).addTo(ST.maps.radar);
  const d = new Date(frame.time * 1000);
  const lbl = document.getElementById('rv-time-label');
  if (lbl) lbl.textContent = d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  const slider = document.getElementById('rv-slider');
  if (slider) slider.value = idx;
  document.querySelectorAll('.rv-frame-tick').forEach(function(el, i) {
    el.classList.toggle('active', i === idx);
  });
}

function toggleRainViewerPlay() {
  const btn = document.getElementById('rv-play-btn');
  if (RV.playing) {
    clearInterval(RV.playTimer);
    RV.playing = false;
    if (btn) btn.innerHTML = '&#9654; Play';
  } else {
    RV.playing = true;
    if (btn) btn.innerHTML = '&#9646;&#9646; Pause';
    RV.playTimer = setInterval(function() {
      var next = RV.currentIdx + 1;
      if (next >= RV.frames.length) next = 0;
      setRainViewerFrame(next);
    }, 500);
  }
}

function updateRVSlider() {
  const slider = document.getElementById('rv-slider');
  if (slider) {
    slider.max = RV.frames.length - 1;
    slider.value = RV.currentIdx;
  }
}

function updateRVTicks() {
  const ticksEl = document.getElementById('rv-ticks');
  if (!ticksEl || !RV.frames.length) return;
  ticksEl.innerHTML = RV.frames.map(function(f, i) {
    const d = new Date(f.time * 1000);
    const lbl = d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    return '<span class="rv-frame-tick' + (i === RV.currentIdx ? ' active' : '') + '" onclick="setRainViewerFrame(' + i + ')">' + lbl + '</span>';
  }).join('');
}

async function refreshRainViewer() {
  const ok = await fetchRainViewerFrames();
  if (ok && RV.frames.length) {
    RV.currentIdx = RV.frames.length - 1;
    setRainViewerFrame(RV.currentIdx);
    updateRVSlider();
    updateRVTicks();
  }
}

// Legacy stubs (IEM radar removed)
function setRadarProduct() {}
function refreshRadar() {}

// ============================================================
// RADAR PRECIP TYPE GRID
// ============================================================
function renderRadarPtypeGrid(om) {
  const container = document.getElementById('radar-ptype-grid');
  if (!om) { if(container) container.innerHTML = '<span class="text-xs text-red-400">HRRR data unavailable</span>'; return; }

  const now = new Date();
  const h = om.hourly;
  const pills = [];

  for (let i = 0; i < h.time.length && pills.length < 12; i++) {
    const t = new Date(h.time[i]);
    if (t < now) continue;
    const ptype = wmoToPrecipType(h.weather_code[i]);
    const label = precipTypeLabel(ptype);
    const badge = precipTypeBadgeClass(ptype);
    const precip = h.precipitation[i] != null ? h.precipitation[i] : 0;
    pills.push('<div class="glass-light px-3 py-2 text-center min-w-16">' +
      '<p class="text-xs font-bold text-slate-400">' + fmtTime(h.time[i]) + '</p>' +
      '<span class="text-xs px-1.5 py-0.5 rounded-full ' + badge + '">' + label + '</span>' +
      (precip > 0 ? '<p class="text-xs text-cyan-400 mt-1">' + precip.toFixed(2) + '"</p>' : '') +
      '</div>');
  }

  const locationLabel = document.getElementById('radar-ptype-location');
  if (locationLabel) locationLabel.textContent = CFG.locationName;

  if(container) container.innerHTML = pills.length
    ? '<p class="text-xs text-slate-500 w-full mb-1">Next 12 hours:</p>' + pills.join('')
    : '<span class="text-xs text-slate-500">No precipitation expected</span>';
}


// ============================================================
// SPC
// ============================================================
function setSpcDay(day) {
  ST.spcDay = day;
  [1,2,3].forEach(d => document.getElementById(`spc-d${d}`)?.classList.toggle('active', d === day));
  const urls = {
    1: 'https://www.spc.noaa.gov/products/outlook/day1otlk.gif',
    2: 'https://www.spc.noaa.gov/products/outlook/day2otlk.gif',
    3: 'https://www.spc.noaa.gov/products/outlook/day3otlk.gif',
  };
  const img = document.getElementById('spc-outlook-img');
  if (img) { img.src = ''; img.src = urls[day]; img.alt = `SPC Day ${day} Convective Outlook`; }
}

function setSpcHazardDay(day) {
  [1,2].forEach(function(d) {
    const btn = document.getElementById('haz-d' + d);
    if (btn) btn.classList.toggle('active', d === day);
  });
  const prefix = day === 2 ? 'day2' : 'day1';
  const ts = Date.now();
  const tornEl = document.getElementById('haz-torn');
  const windEl = document.getElementById('haz-wind');
  const hailEl = document.getElementById('haz-hail');
  if (tornEl) { tornEl.src = ''; tornEl.src = 'https://www.spc.noaa.gov/products/outlook/' + prefix + 'probotlk_torn.gif?_=' + ts; }
  if (windEl) { windEl.src = ''; windEl.src = 'https://www.spc.noaa.gov/products/outlook/' + prefix + 'probotlk_wind.gif?_=' + ts; }
  if (hailEl) { hailEl.src = ''; hailEl.src = 'https://www.spc.noaa.gov/products/outlook/' + prefix + 'probotlk_hail.gif?_=' + ts; }
}

function handleSpcImgError() {
  const img = document.getElementById('spc-outlook-img');
  if (!img) return;
  img.insertAdjacentHTML('afterend', `<div class="glass-light p-6 text-center text-slate-500 text-sm mt-2">
    <p class="mb-2">\u26a0\ufe0f SPC outlook image unavailable.</p>
    <a href="https://www.spc.noaa.gov/products/outlook/" target="_blank" class="text-blue-400 underline">View SPC Outlooks \u2192</a>
  </div>`);
}

// ============================================================
// CONDITIONS MAP  \u2014 Custom station markers
// ============================================================
function createStationIcon(s) {
  const tc = tempColor(s.tempF);
  const icon = conditionIcon(s.sky, s.textDescription);
  const wd = windDirArrow(s.windDir);
  const ws = s.windMph != null ? Math.round(s.windMph) : 0;
  const wdDeg = s.windDir != null ? s.windDir : 0;

  // Derive a muted fill color from the temperature color
  const fillAlpha = 0.18;
  // simple mapping of hex to rgba via luminance assumption
  const html = `<div class="stn-plot">
    <div class="stn-id-lbl">${s.id}</div>
    <div class="stn-circle" style="color:${tc};background:${tc}22">
      <span style="filter:drop-shadow(0 1px 2px rgba(0,0,0,0.6))">${icon}</span>
    </div>
    <div class="stn-temp-lbl" style="color:${tc}">${Math.round(s.tempF)}\u00b0F</div>
    <div class="stn-wind-lbl">
      <span style="display:inline-block;transform:rotate(${wdDeg}deg);font-size:10px">\u2191</span>
      ${ws}mph
    </div>
  </div>`;

  return L.divIcon({
    html,
    className: '',
    iconSize: [50, 70],
    iconAnchor: [25, 35],
    popupAnchor: [0, -40],
  });
}

function clearStationMarkers() {
  if (ST.stationMarkers.length && ST.maps.conditions) {
    ST.stationMarkers.forEach(m => m.remove());
  }
  ST.stationMarkers = [];
}

function renderConditionsMap(stations) {
  if (!ST.maps.conditions) return;
  clearStationMarkers();

  // Home/selected location marker
  const homeIco = L.divIcon({
    html: `<div class="stn-plot">
      <div class="stn-circle" style="color:#f59e0b;background:#f59e0b22;font-size:20px">â˜…</div>
      <div class="stn-temp-lbl" style="color:#fbbf24;max-width:70px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:9px">${CFG.locationName.split(',')[0]}</div>
    </div>`,
    className: '', iconSize: [70, 55], iconAnchor: [35, 27],
  });
  const homeM = L.marker([CFG.lat, CFG.lon], { icon: homeIco, zIndexOffset: 1000 }).addTo(ST.maps.conditions);
  ST.stationMarkers.push(homeM);

  stations.forEach(s => {
    const icon = createStationIcon(s);
    const tc = tempColor(s.tempF);
    const marker = L.marker([s.lat, s.lon], { icon })
      .addTo(ST.maps.conditions)
      .on('click', () => showStationDetail(s.id));
    ST.stationMarkers.push(marker);
  });
}

function initConditionsMap(stations) {
  if (ST.mapsInited.conditions) {
    // already inited \u2014 just update markers
    ST.maps.conditions.setView([CFG.lat, CFG.lon], 7);
    renderConditionsMap(stations);
    return;
  }
  ST.mapsInited.conditions = true;

  const map = L.map('conditions-map', {
    center: [CFG.lat, CFG.lon], zoom: 7, zoomControl: true
  });
  ST.maps.conditions = map;

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '\u00a9 OpenStreetMap contributors \u00a9 CARTO',
    subdomains: 'abcd', maxZoom: 19,
  }).addTo(map);

  // Render station markers (renderConditionsMap also adds the home marker)
  renderConditionsMap(stations);

  // Temperature legend
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const d = document.createElement('div');
    d.style.cssText = 'background:rgba(5,10,25,0.9);border:1px solid rgba(99,131,255,0.2);border-radius:10px;padding:10px 12px;font-family:Inter,sans-serif;font-size:11px;color:#94a3b8';
    d.innerHTML = `<p style="font-weight:700;margin:0 0 6px;color:#e2e8f0">Temperature</p>
      ${[['>=90\u00b0','#ef4444'],['80\u00b0','#f97316'],['70\u00b0','#f59e0b'],
         ['60\u00b0','#84cc16'],['50\u00b0','#22d3ee'],['40\u00b0','#60a5fa'],
         ['32\u00b0','#818cf8'],['<32\u00b0','#c4b5fd']].map(([l,c]) =>
        `<div style="display:flex;align-items:center;gap:6px;margin:2px 0">
          <span style="width:10px;height:10px;background:${c};border-radius:50%;display:inline-block"></span>
          <span>${l}</span></div>`).join('')}
    <p style="margin-top:6px;font-size:9px;color:#475569">Click marker for full data</p>`;
    return d;
  };
  legend.addTo(map);
}

// ============================================================
// RENDER STATION TABLE
// ============================================================
function renderStationTable(stations) {
  const tbody = document.getElementById('station-table-body');
  if (!stations.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-slate-500">No station data available</td></tr>';
    return;
  }
  tbody.innerHTML = stations.map(s => {
    const tc = tempColor(s.tempF);
    const wd = windDirArrow(s.windDir);
    const ws = s.windMph != null ? `${Math.round(s.windMph)} mph ${wd}` : '\u2014';
    return `<tr class="border-b border-slate-800/60 hover:bg-slate-800/20 transition-colors cursor-pointer"
        onclick="showStationDetail('${s.id}')">
      <td class="py-2.5 pr-4">
        <p class="font-semibold text-white text-xs">${s.id}</p>
        <p class="text-xs text-slate-500 leading-tight">${s.name}</p>
      </td>
      <td class="py-2.5 text-right font-bold text-sm" style="color:${tc}">${Math.round(s.tempF)}\u00b0F</td>
      <td class="py-2.5 text-right text-sm text-slate-300">${ws}</td>
      <td class="py-2.5 text-right text-sm text-slate-400">${s.humidity != null ? Math.round(s.humidity)+'%' : '\u2014'}</td>
      <td class="py-2.5 text-right text-sm">${skyEmoji(s.sky)} ${s.sky}</td>
      <td class="py-2.5 text-right text-xs text-slate-400">${s.textDescription}</td>
    </tr>`;
  }).join('');
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn[data-tab]').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById(`tab-${tab}`)?.classList.add('active');

  if (tab === 'radar' && !ST.mapsInited.radar) setTimeout(initRadarMap, 50);
  if (tab === 'conditions' && ST.stations.length) {
    if (!ST.mapsInited.conditions) {
      setTimeout(() => initConditionsMap(ST.stations), 50);
    } else {
      setTimeout(() => ST.maps.conditions?.invalidateSize(), 100);
    }
  }
  if (tab === 'snowfall') {
    // Init snowfall chart if we have data
    if (ST.nwsSnowfall) renderSnowfallChart(ST.nwsSnowfall);
    setSnowMapDay(ST.snowMapDay || 1);
  }
}

document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

// ESC closes modal
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ============================================================
// MAIN INIT
// ============================================================
async function refreshAll() {
  const btn = document.getElementById('refresh-btn');
  if (btn) btn.classList.add('animate-spin');

  try {
    const [omData, nwsForecast, nwsHourly, stations, snowfall] = await Promise.allSettled([
      fetchOpenMeteo(),
      fetchNWSForecast(),
      fetchNWSHourly(),
      fetchStations(),
      fetchNWSSnowfall(),
    ]);

    if (omData.status === 'fulfilled') {
      ST.openMeteo = omData.value;
      renderHeader(ST.openMeteo);
      renderForecastChart(ST.openMeteo);
      renderRadarPtypeGrid(ST.openMeteo);
    }

    if (nwsForecast.status === 'fulfilled') {
      ST.nwsForecast = nwsForecast.value;
      renderDailyForecast(ST.nwsForecast);
    }

    if (nwsHourly.status === 'fulfilled') {
      ST.nwsHourly = nwsHourly.value;
      renderHourlyScroll(ST.nwsHourly, ST.openMeteo?.hourly ?? null);
    }

    if (stations.status === 'fulfilled') {
      ST.stations = stations.value;
      renderStationTable(ST.stations);
      if (ST.mapsInited.conditions) {
        renderConditionsMap(ST.stations);
      }
    }

    if (snowfall.status === 'fulfilled' && snowfall.value) {
      ST.nwsSnowfall = snowfall.value;
      // Only render chart if snowfall tab is active
      const snowTab = document.getElementById('tab-snowfall');
      if (snowTab?.classList.contains('active')) {
        renderSnowfallChart(ST.nwsSnowfall);
      }
    }

    document.getElementById('global-loading').classList.add('hidden');
    document.getElementById('tab-forecast').classList.add('active');

    // Init WPC snowfall map
    setSnowMapDay(ST.snowMapDay || 1);

  } catch (err) {
    console.error(err);
    document.getElementById('global-loading').classList.add('hidden');
    document.getElementById('global-error').classList.remove('hidden');
    document.getElementById('error-text').textContent = err.message;
  } finally {
    if (btn) btn.classList.remove('animate-spin');
  }
}

// \u2500\u2500 Start \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
document.addEventListener('DOMContentLoaded', () => {
  initSearch();
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        CFG.lat = pos.coords.latitude;
        CFG.lon = pos.coords.longitude;
        CFG.locationName = 'Your Location';
        // Try to get city name from reverse geocode
        fetch('https://geocoding-api.open-meteo.com/v1/reverse?latitude=' + CFG.lat + '&longitude=' + CFG.lon + '&language=en')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.results && data.results[0]) {
              var r = data.results[0];
              CFG.locationName = r.name || 'Your Location';
              CFG.timezone = r.timezone || 'America/New_York';
              var locEl = document.getElementById('location-name');
              if (locEl) locEl.textContent = CFG.locationName;
            }
          })
          .catch(function() {});
        refreshAll();
      },
      function(_err) { refreshAll(); },
      { timeout: 5000, maximumAge: 300000 }
    );
  } else {
    refreshAll();
  }
  setInterval(refreshAll, CFG.refreshMs);
});
</script>
</body>
</html>
=======
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">Ephrata, PA â€” Weather</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* Your full CSS here â€” unchanged */
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #e2e8f0;
      min-height: 100vh;
    }

    .glass-light {
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(99, 131, 255, 0.18);
      border-radius: 16px;
    }

    .pulse-soft {
      animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* â”€â”€ Search bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-wrap { position: relative; flex: 1; max-width: 420px; }
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      background: rgba(10,20,50,0.65);
      border: 1px solid rgba(99,131,255,0.22);
      border-radius: 10px;
      color: #e2e8f0;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.2s;
    }
    .search-input:focus {
      border-color: rgba(99,131,255,0.55);
      background: rgba(15,25,65,0.85);
      box-shadow: 0 0 0 3px rgba(99,131,255,0.1);
    }
    .search-input::placeholder { color: rgba(148,163,184,0.45); }
    .search-icon-wrap {
      position: absolute; left: 10px; top: 50%;
      transform: translateY(-50%); color: rgba(148,163,184,0.45);
      pointer-events: none;
    }
    .search-dropdown {
      position: absolute; top: calc(100% + 6px); left: 0; right: 0;
      background: rgba(7,12,32,0.98);
      border: 1px solid rgba(99,131,255,0.22);
      border-radius: 14px; overflow: hidden; z-index: 9000;
      box-shadow: 0 16px 48px rgba(0,0,0,0.65);
      max-height: 420px; overflow-y: auto;
    }
    .search-dropdown.hidden { display: none; }
    .sdrop-label {
      padding: 9px 14px 4px;
      font-size: 0.67rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: rgba(148,163,184,0.38);
    }
    .sdrop-item {
      padding: 10px 14px; cursor: pointer;
      display: flex; align-items: center; gap: 10px;
      transition: background 0.12s;
      border-top: 1px solid rgba(255,255,255,0.03);
    }
    .sdrop-item:first-child { border-top: none; }
    .sdrop-item:hover { background: rgba(99,131,255,0.1); }
    .sdrop-item-icon { font-size: 1.1rem; width: 22px; text-align: center; flex-shrink: 0; }
    .sdrop-item-text { flex: 1; min-width: 0; }
    .sdrop-item-name { font-size: 0.855rem; font-weight: 500; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sdrop-item-sub { font-size: 0.72rem; color: #64748b; }
    .sdrop-fav-btn {
      padding: 3px 7px; font-size: 0.78rem; cursor: pointer;
      background: none; border: none; flex-shrink: 0;
      color: #f59e0b; opacity: 0.55; transition: opacity 0.15s;
    }
    .sdrop-fav-btn:hover { opacity: 1; }
    .sdrop-fav-btn.active { opacity: 1; }
    .sdrop-divider { height: 1px; background: rgba(255,255,255,0.05); margin: 2px 0; }

    /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(5px);
      z-index: 8000;
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
      opacity: 0; pointer-events: none; transition: opacity 0.22s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal-card {
      background: rgba(9,16,44,0.99);
      border: 1px solid rgba(99,131,255,0.22);
      border-radius: 20px; padding: 22px;
      max-width: 540px; width: 100%;
      max-height: 88vh; overflow-y: auto;
      transform: translateY(18px); transition: transform 0.22s;
      scrollbar-width: thin;
    }
    .modal-overlay.open .modal-card { transform: translateY(0); }

    /* ... rest of your modal + station plot + card styles unchanged ... */

    .snow-chart-wrap { position: relative; height: 200px; margin-bottom: 8px; }
  </style>
</head>
<body>
 
      <!-- HRRR Precip Type for location -->
      <div class="mt-3 glass-light p-3">
        <p class="text-xs text-slate-500 font-semibold uppercase tracking-widest mb-2">
          HRRR-Derived Precip Type Â· Ephrata, PA
        </p>
        <div id="radar-ptype-grid" class="flex flex-wrap gap-2">
          <span class="text-xs text-slate-400 pulse-soft">Loading HRRR model dataâ€¦</span>
        </div>
        <p class="text-xs text-slate-600 mt-2">
          Precip type determined from HRRR model weather codes (WMO) via Open-Meteo API,
          not from MRMS PrecipFlag, avoiding categorical flag ambiguities.
        </p>
      </div>
    </section>
  </div>
 
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB: SNOWFALL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-snowfall" class="tab-panel space-y-4">
 
    <!-- NOHRSC Snowfall Analysis -->
    <section class="glass p-5 fade-up">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <p class="section-title mb-0">NOHRSC Snowfall Analysis (CONUS)</p>
        <div class="flex gap-2 flex-wrap">
          <button onclick="setSnowPeriod(24)"  id="snow-24"  class="tab-btn active text-xs px-3 py-1.5">24h</button>
          <button onclick="setSnowPeriod(48)"  id="snow-48"  class="tab-btn text-xs px-3 py-1.5">48h</button>
          <button onclick="setSnowPeriod(72)"  id="snow-72"  class="tab-btn text-xs px-3 py-1.5">72h</button>
          <button onclick="setSnowPeriod(168)" id="snow-168" class="tab-btn text-xs px-3 py-1.5">7-Day</button>
        </div>
      </div>
      <div class="relative">
        <img id="snow-nohrsc" src="" alt="NOHRSC Snowfall Analysis"
          class="wx-image" onerror="this.src=''; this.closest('.relative').innerHTML=snowFallback()" />
      </div>
      <p class="text-xs text-slate-600 mt-2">
        Source: NOAA National Operational Hydrologic Remote Sensing Center (NOHRSC).
        Analysis updates every 6 hours at 00Z, 06Z, 12Z, 18Z.
      </p>
    </section>
 
    <!-- WPC Snowfall Probability -->
    <section class="glass p-5 fade-up">
      <p class="section-title">WPC Snowfall Probability Outlooks</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">Day 1</p>
          <img src="https://www.wpc.ncep.noaa.gov/wwd/pwpf_d47/pwpf_medr_d1.gif"
            alt="WPC Day 1 Snow" class="wx-image"
            onerror="this.alt='Image unavailable'; this.style.display='none'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">Day 2</p>
          <img src="https://www.wpc.ncep.noaa.gov/wwd/pwpf_d47/pwpf_medr_d2.gif"
            alt="WPC Day 2 Snow" class="wx-image"
            onerror="this.alt='Image unavailable'; this.style.display='none'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">Day 3</p>
          <img src="https://www.wpc.ncep.noaa.gov/wwd/pwpf_d47/pwpf_medr_d3.gif"
            alt="WPC Day 3 Snow" class="wx-image"
            onerror="this.alt='Image unavailable'; this.style.display='none'" />
        </div>
      </div>
      <p class="text-xs text-slate-600 mt-2">
        Source: NOAA/NWS Weather Prediction Center (WPC). Probability of â‰¥0.1&quot; snowfall accumulation.
      </p>
    </section>
 
    <!-- NWS Winter Storm Outlook -->
    <section class="glass p-5 fade-up">
      <p class="section-title">NWS Winter Weather Outlook (Day 4â€“7)</p>
      <img src="https://www.wpc.ncep.noaa.gov/wwd/wssi/day4_7_wssi.png"
        alt="Winter Storm Severity Index" class="wx-image"
        onerror="this.style.display='none'" />
      <p class="text-xs text-slate-600 mt-2">
        Source: WPC Winter Storm Severity Index (WSSI).
      </p>
    </section>
  </div>
 
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB: SPC
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-spc" class="tab-panel space-y-4">
 
    <!-- Convective Outlooks -->
    <section class="glass p-5 fade-up">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
        <p class="section-title mb-0">SPC Convective Outlooks</p>
        <div class="flex gap-2">
          <button onclick="setSpcDay(1)" id="spc-d1" class="tab-btn active text-xs px-3 py-1.5">Day 1</button>
          <button onclick="setSpcDay(2)" id="spc-d2" class="tab-btn text-xs px-3 py-1.5">Day 2</button>
          <button onclick="setSpcDay(3)" id="spc-d3" class="tab-btn text-xs px-3 py-1.5">Day 3</button>
        </div>
      </div>
 
      <img id="spc-outlook-img" src="https://www.spc.noaa.gov/products/outlook/day1otlk.gif"
        alt="SPC Day 1 Convective Outlook" class="wx-image"
        onerror="this.src=''; handleSpcImgError()" />
 
      <!-- Risk Legend -->
      <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2">
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-green-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-tstm">TSTM</p>
          <p class="text-xs text-slate-500 mt-0.5">Gen. Thunder</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-green-300/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-mrgl">MRGL</p>
          <p class="text-xs text-slate-500 mt-0.5">Marginal</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-yellow-300/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-slgt">SLGT</p>
          <p class="text-xs text-slate-500 mt-0.5">Slight</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-orange-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-enh">ENH</p>
          <p class="text-xs text-slate-500 mt-0.5">Enhanced</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-red-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-mdt">MDT</p>
          <p class="text-xs text-slate-500 mt-0.5">Moderate</p>
        </div>
        <div class="glass-light p-2 text-center">
          <div class="w-3 h-3 rounded-full bg-fuchsia-400/60 mx-auto mb-1"></div>
          <p class="text-xs font-bold risk-high">HIGH</p>
          <p class="text-xs text-slate-500 mt-0.5">High</p>
        </div>
      </div>
    </section>
 
    <!-- Tornado / Wind / Hail breakdown (Day 1) -->
    <section class="glass p-5 fade-up">
      <p class="section-title">SPC Hazard Probability Maps (Day 1)</p>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">ğŸŒª Tornado</p>
          <img src="https://www.spc.noaa.gov/products/outlook/day1probotlk_torn.gif"
            alt="Tornado Prob" class="wx-image" onerror="this.style.display='none'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">ğŸ’¨ Damaging Wind</p>
          <img src="https://www.spc.noaa.gov/products/outlook/day1probotlk_wind.gif"
            alt="Wind Prob" class="wx-image" onerror="this.style.display='none'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">ğŸŒ© Large Hail</p>
          <img src="https://www.spc.noaa.gov/products/outlook/day1probotlk_hail.gif"
            alt="Hail Prob" class="wx-image" onerror="this.style.display='none'" />
        </div>
      </div>
    </section>
 
    <!-- Fire Weather -->
    <section class="glass p-5 fade-up">
      <p class="section-title">SPC Fire Weather Outlook</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">Day 1</p>
          <img src="https://www.spc.noaa.gov/products/fire_wx/fwdy1.gif"
            alt="Fire Day 1" class="wx-image" onerror="this.style.display='none'" />
        </div>
        <div class="glass-light p-3">
          <p class="text-xs font-semibold text-slate-400 mb-2 text-center">Day 2</p>
          <img src="https://www.spc.noaa.gov/products/fire_wx/fwdy2.gif"
            alt="Fire Day 2" class="wx-image" onerror="this.style.display='none'" />
        </div>
      </div>
      <p class="text-xs text-slate-600 mt-2">Source: NOAA Storm Prediction Center (SPC). Updates daily.</p>
    </section>
  </div>
 
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB: CONDITIONS MAP
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-conditions" class="tab-panel space-y-4">
 
    <section class="glass p-4 fade-up">
      <p class="section-title">Current Surface Observations Â· Central PA Region</p>
      <div id="conditions-map" class="map-container"></div>
      <div class="mt-3 flex flex-wrap gap-3 text-xs text-slate-500">
        <span>ğŸŒ¡ Temperature</span>
        <span>ğŸ’¨ Wind speed &amp; direction</span>
        <span>â˜ Cloud cover</span>
        <span>Sources: NWS ASOS station observations</span>
      </div>
    </section>
 
    <!-- Station Table -->
    <section class="glass p-5 fade-up">
      <p class="section-title">Station Observations</p>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs text-slate-500 border-b border-slate-700/50">
              <th class="text-left pb-2 font-semibold">Station</th>
              <th class="text-right pb-2 font-semibold">Temp</th>
              <th class="text-right pb-2 font-semibold">Wind</th>
              <th class="text-right pb-2 font-semibold">Humidity</th>
              <th class="text-right pb-2 font-semibold">Sky</th>
              <th class="text-right pb-2 font-semibold">Weather</th>
            </tr>
          </thead>
          <tbody id="station-table-body">
            <tr><td colspan="6" class="py-4 text-center text-slate-500 pulse-soft">Loading stationsâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>
 
  <!-- â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <footer class="text-center text-xs text-slate-700 py-2 fade-up" style="animation-delay:0.3s">
    Data: NWS Â· Open-Meteo HRRR Â· IEM/NOAA MRMS Â· NOHRSC Â· WPC Â· SPC Â·
    <span id="footer-updated"></span>
  </footer>
 
</div><!-- #app -->
 
<script>
// ============================================================
// CONFIG
// ============================================================
const CFG = {
  lat: 40.1773,
  lon: -76.1869,
  nwsOffice: 'CTP',
  nwsX: 92,
  nwsY: 76,
  userAgent: '(EphrataWeatherApp, weather@ephrata.example)',
  refreshMs: 600_000,
};
 
// ============================================================
// STATE
// ============================================================
let ST = {
  openMeteo: null,
  nwsForecast: null,
  nwsHourly: null,
  stations: [],
  radarProduct: 'nexrad-n0q-900913',
  snowPeriod: 24,
  spcDay: 1,
  maps: { radar: null, conditions: null },
  layers: { radar: null },
  chart: null,
  mapsInited: { radar: false, conditions: false },
};
 
// ============================================================
// UTILITY
// ============================================================
function cToF(c) { return c == null ? null : (c * 9/5) + 32; }
function mpsToMph(v) { return v == null ? null : v * 2.23694; }
function kmhToMph(v) { return v == null ? null : v * 0.621371; }
function round1(v) { return Math.round(v * 10) / 10; }
 
function tempColor(f) {
  if (f == null) return '#94a3b8';
  if (f >= 95) return '#ef4444';
  if (f >= 85) return '#f97316';
  if (f >= 75) return '#f59e0b';
  if (f >= 65) return '#84cc16';
  if (f >= 55) return '#22d3ee';
  if (f >= 45) return '#60a5fa';
  if (f >= 32) return '#818cf8';
  return '#c4b5fd';
}
 
function windDirArrow(deg) {
  if (deg == null) return 'â€“';
  const dirs = ['N','NE','E','SE','S','SW','W','NW'];
  return dirs[Math.round(deg / 45) % 8];
}
 
function skyEmoji(amount) {
  const m = { CLR:'â˜€ï¸', SKC:'â˜€ï¸', FEW:'ğŸŒ¤', SCT:'â›…', BKN:'ğŸŒ¥', OVC:'â˜ï¸' };
  return m[amount] || 'ğŸŒ¥';
}
 
// WMO weather code â†’ precip type string
function wmoToPrecipType(code) {
  if (code == null) return 'none';
  if ([95,96,99].includes(code)) return 'tstm';
  if ([66,67].includes(code)) return 'frzr';
  if ([56,57].includes(code)) return 'frzr';
  if (code >= 71 && code <= 77) return 'snow';
  if ([85,86].includes(code)) return 'snow';
  if (code >= 61 && code <= 65) return 'rain';
  if (code >= 51 && code <= 55) return 'rain';
  if (code >= 80 && code <= 82) return 'rain';
  if (code >= 1 && code <= 3) return 'none';
  if (code === 0) return 'none';
  return 'none';
}
 
function precipTypeLabel(type) {
  return { rain:'ğŸ’§ Rain', snow:'â„ï¸ Snow', frzr:'ğŸ§Š Freezing Rain', mix:'ğŸŒ€ Mix',
           tstm:'â›ˆ Thunder', none:'None' }[type] || 'None';
}
 
function precipTypeBadgeClass(type) {
  return { rain:'badge-rain', snow:'badge-snow', frzr:'badge-frzr',
           mix:'badge-mix', tstm:'badge-tstm', none:'badge-none' }[type] || 'badge-none';
}
 
function wmoDesc(code) {
  if (code == null) return 'â€”';
  const m = {
    0:'Clear', 1:'Mainly Clear', 2:'Partly Cloudy', 3:'Overcast',
    45:'Fog', 48:'Icy Fog',
    51:'Light Drizzle', 53:'Drizzle', 55:'Heavy Drizzle',
    56:'Lt Frz Drizzle', 57:'Hvy Frz Drizzle',
    61:'Light Rain', 63:'Rain', 65:'Heavy Rain',
    66:'Lt Frz Rain', 67:'Hvy Frz Rain',
    71:'Light Snow', 73:'Snow', 75:'Heavy Snow', 77:'Snow Grains',
    80:'Light Showers', 81:'Showers', 82:'Heavy Showers',
    85:'Snow Showers', 86:'Heavy Snow Showers',
    95:'Thunderstorm', 96:'Tstm + Hail', 99:'Tstm + Heavy Hail',
  };
  return m[code] || `Code ${code}`;
}
 
function fmtTime(iso) {
  const d = new Date(iso);
  const h = d.getHours();
  const ampm = h >= 12 ? 'PM' : 'AM';
  return `${h%12||12}${ampm}`;
}
 
function fmtDay(iso) {
  const d = new Date(iso);
  const today = new Date();
  const tom = new Date(today); tom.setDate(today.getDate()+1);
  if (d.toDateString() === today.toDateString()) return 'Today';
  if (d.toDateString() === tom.toDateString()) return 'Tomorrow';
  return d.toLocaleDateString('en-US',{weekday:'short'});
}
 
function nwsIconUrl(url, size='small') {
  // upgrade to larger icon
  if (!url) return '';
  return url.replace(/\?size=\w+/, '') + '?size=' + size;
}
 
// ============================================================
// NOHRSC URL
// ============================================================
function nohrscUrl(hours) {
  // Construct latest NOHRSC snowfall analysis URL
  // NOHRSC runs at 00Z,06Z,12Z,18Z â€“ find most recent
  const now = new Date();
  const utcH = now.getUTCHours();
  const runH = Math.floor(utcH / 6) * 6;
  const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), runH));
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth()+1).padStart(2,'0');
  const dd = String(d.getUTCDate()).padStart(2,'0');
  const hh = String(d.getUTCHours()).padStart(2,'0');
  const key = hours === 168 ? '10day' : `${hours}h`;
  return `https://www.nohrsc.noaa.gov/snowfall/data/${yyyy}${mm}/sfav3_CONUS_${key}_${yyyy}${mm}${dd}${hh}.gif`;
}
 
function snowFallback() {
  return `<div class="glass-light p-6 text-center text-slate-500 text-sm">
    <p class="mb-2">âš ï¸ Snowfall image unavailable for the current analysis time.</p>
    <a href="https://www.nohrsc.noaa.gov/snowfall/" target="_blank"
       class="text-blue-400 underline">View NOHRSC Snowfall Analysis â†’</a>
  </div>`;
}
 
// ============================================================
// API FETCHING
// ============================================================
async function fetchNWSForecast() {
  const url = `https://api.weather.gov/gridpoints/${CFG.nwsOffice}/${CFG.nwsX},${CFG.nwsY}/forecast`;
  const r = await fetch(url, { headers:{'User-Agent': CFG.userAgent} });
  if (!r.ok) throw new Error(`NWS forecast: ${r.status}`);
  const d = await r.json();
  return d.properties.periods;
}
 
async function fetchNWSHourly() {
  const url = `https://api.weather.gov/gridpoints/${CFG.nwsOffice}/${CFG.nwsX},${CFG.nwsY}/forecast/hourly`;
  const r = await fetch(url, { headers:{'User-Agent': CFG.userAgent} });
  if (!r.ok) throw new Error(`NWS hourly: ${r.status}`);
  const d = await r.json();
  return d.properties.periods;
}
 
async function fetchOpenMeteo() {
  const params = new URLSearchParams({
    latitude: CFG.lat,
    longitude: CFG.lon,
    current: 'temperature_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,relative_humidity_2m,cloud_cover,precipitation',
    hourly: 'temperature_2m,weather_code,precipitation,rain,snowfall,cloud_cover,wind_speed_10m,wind_direction_10m,visibility,cape',
    temperature_unit: 'fahrenheit',
    wind_speed_unit: 'mph',
    precipitation_unit: 'inch',
    timezone: 'America/New_York',
    forecast_days: 7,
  });
  const r = await fetch(`https://api.open-meteo.com/v1/forecast?${params}`);
  if (!r.ok) throw new Error(`Open-Meteo: ${r.status}`);
  return r.json();
}
 
async function fetchStations() {
  // Get stations associated with the CTP grid point
  const url = `https://api.weather.gov/gridpoints/${CFG.nwsOffice}/${CFG.nwsX},${CFG.nwsY}/stations`;
  const r = await fetch(url, { headers:{'User-Agent': CFG.userAgent} });
  if (!r.ok) return [];
  const d = await r.json();
  const features = (d.features || []).slice(0, 22);
 
  const results = await Promise.allSettled(
    features.map(f =>
      fetch(`${f.id}/observations/latest`, { headers:{'User-Agent': CFG.userAgent} })
        .then(res => res.ok ? res.json() : null)
        .catch(() => null)
    )
  );
 
  return results
    .map((res, i) => {
      if (res.status !== 'fulfilled' || !res.value) return null;
      const obs = res.value;
      const p = obs.properties;
      const f = features[i];
      if (!p || p.temperature?.value == null) return null;
 
      // Wind speed: NWS returns km/h
      const windKmh = p.windSpeed?.value ?? null;
      const windMph = windKmh != null ? windKmh * 0.621371 : null;
 
      return {
        id: f.properties.stationIdentifier,
        name: f.properties.name,
        lat: f.geometry.coordinates[1],
        lon: f.geometry.coordinates[0],
        tempF: cToF(p.temperature.value),
        windMph,
        windDir: p.windDirection?.value ?? null,
        humidity: p.relativeHumidity?.value ?? null,
        sky: p.cloudLayers?.[0]?.amount ?? 'CLR',
        textDescription: p.textDescription ?? 'â€”',
        timestamp: p.timestamp,
      };
    })
    .filter(Boolean);
}
 
// ============================================================
// RENDER HEADER (uses Open-Meteo current)
// ============================================================
function renderHeader(om) {
  const c = om.current;
  const tempF = c.temperature_2m;
  const ptype = wmoToPrecipType(c.weather_code);
  const desc = wmoDesc(c.weather_code);
 
  document.getElementById('hdr-temp').textContent = `${Math.round(tempF)}Â°F`;
  document.getElementById('hdr-temp').style.color = tempColor(tempF);
  document.getElementById('hdr-desc').textContent = desc;
  document.getElementById('stat-feels').textContent = `${Math.round(c.apparent_temperature)}Â°F`;
  document.getElementById('stat-wind').textContent =
    `${Math.round(c.wind_speed_10m)} mph ${windDirArrow(c.wind_direction_10m)}`;
  document.getElementById('stat-humid').textContent = `${Math.round(c.relative_humidity_2m)}%`;
  document.getElementById('stat-cloud').textContent = `${Math.round(c.cloud_cover)}%`;
 
  const ptEl = document.getElementById('stat-ptype');
  ptEl.textContent = precipTypeLabel(ptype);
  ptEl.className = `text-sm font-bold px-2 py-0.5 rounded-full ${precipTypeBadgeClass(ptype)}`;
 
  const now = new Date();
  const upd = now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  document.getElementById('stat-updated').textContent = upd;
  document.getElementById('footer-updated').textContent = `Updated ${upd}`;
}
 
// ============================================================
// RENDER 7-DAY FORECAST (NWS periods â€“ pair day/night)
// ============================================================
function renderDailyForecast(periods) {
  // NWS periods alternate day/night. Group into days.
  const days = [];
  let i = 0;
  while (i < periods.length && days.length < 7) {
    const p = periods[i];
    if (p.isDaytime) {
      const night = periods[i+1];
      days.push({ day: p, night });
      i += 2;
    } else {
      // starts at night
      days.push({ day: null, night: p });
      i++;
    }
  }
 
  const grid = document.getElementById('daily-grid');
  grid.innerHTML = days.map((pair, idx) => {
    const main = pair.day || pair.night;
    const dayLabel = idx === 0 ? 'Today' : fmtDay(main.startTime);
    const hiTemp = pair.day?.temperature ?? 'â€”';
    const loTemp = pair.night?.temperature ?? 'â€”';
    const hiColor = tempColor(pair.day?.temperature);
    const loColor = tempColor(pair.night?.temperature);
    const icon = nwsIconUrl(main.icon, 'medium');
    const pop = main.probabilityOfPrecipitation?.value ?? 0;
 
    return `<div class="day-card fade-up" style="animation-delay:${idx*0.04}s">
      <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">${dayLabel}</p>
      <img src="${icon}" alt="${main.shortForecast}" class="w-14 h-14 my-2 rounded-xl" />
      <div class="flex gap-2 items-baseline">
        <span class="text-xl font-extrabold" style="color:${hiColor}">${hiTemp}Â°</span>
        ${loTemp !== 'â€”' ? `<span class="text-sm font-semibold" style="color:${loColor}">${loTemp}Â°</span>` : ''}
      </div>
      <p class="text-xs text-slate-400 mt-1 leading-tight">${main.shortForecast}</p>
      ${pop > 0 ? `<p class="text-xs mt-1 text-cyan-400 font-semibold">ğŸ’§ ${pop}%</p>` : ''}
    </div>`;
  }).join('');
}
 
// ============================================================
// RENDER HOURLY SCROLL (NWS next 48 periods)
// ============================================================
function renderHourlyScroll(periods, omHourly) {
  const next48 = periods.slice(0, 48);
 
  // Build Open-Meteo hourly lookup by ISO hour
  const omLookup = {};
  if (omHourly) {
    omHourly.time.forEach((t, idx) => {
      const key = t.slice(0, 13); // 'YYYY-MM-DDTHH'
      omLookup[key] = {
        ptype: wmoToPrecipType(omHourly.weather_code[idx]),
        rain: omHourly.rain[idx],
        snow: omHourly.snowfall[idx],
        precip: omHourly.precipitation[idx],
      };
    });
  }
 
  const container = document.getElementById('hourly-scroll');
  container.innerHTML = next48.map((p, idx) => {
    const time = fmtTime(p.startTime);
    const tempF = p.temperature;
    const tc = tempColor(tempF);
    const pop = p.probabilityOfPrecipitation?.value ?? 0;
    const icon = nwsIconUrl(p.icon, 'small');
 
    // Resolve precip type from Open-Meteo HRRR
    const omKey = p.startTime.slice(0, 13);
    const om = omLookup[omKey] || {};
    const ptype = om.ptype || 'none';
    const badgeCls = precipTypeBadgeClass(ptype);
    const ptLabel = ptype !== 'none' ? precipTypeLabel(ptype) : '';
 
    return `<div class="hourly-card fade-up" style="animation-delay:${Math.min(idx,12)*0.02}s">
      <p class="text-xs font-bold text-slate-400">${time}</p>
      <img src="${icon}" alt="${p.shortForecast}" class="w-10 h-10 rounded-lg" />
      <p class="text-base font-extrabold" style="color:${tc}">${tempF}Â°</p>
      ${pop > 0 ? `<p class="text-xs text-cyan-400 font-semibold">${pop}%</p>` : ''}
      ${ptLabel ? `<span class="text-xs px-1.5 py-0.5 rounded-full ${badgeCls} leading-tight">${ptLabel}</span>` : ''}
    </div>`;
  }).join('');
}
 
// ============================================================
// RENDER CHART (Chart.js â€“ 48h temp + precip)
// ============================================================
function renderForecastChart(om) {
  const ctx = document.getElementById('forecast-chart');
  if (!ctx || !om) return;
  if (ST.chart) { ST.chart.destroy(); ST.chart = null; }
 
  const h = om.hourly;
  const slice = 48;
  const labels = h.time.slice(0, slice).map(t => {
    const d = new Date(t);
    return d.getHours() === 0
      ? d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})
      : fmtTime(t);
  });
 
  const temps = h.temperature_2m.slice(0, slice);
  const precips = h.precipitation.slice(0, slice);
  const codes = h.weather_code.slice(0, slice);
 
  // Color each precip bar by type
  const precipColors = precips.map((v, i) => {
    if (v <= 0) return 'rgba(0,0,0,0)';
    const pt = wmoToPrecipType(codes[i]);
    const clrs = {
      rain: 'rgba(6,182,212,0.6)',
      snow: 'rgba(148,163,184,0.65)',
      frzr: 'rgba(125,211,252,0.65)',
      mix:  'rgba(139,92,246,0.65)',
      tstm: 'rgba(250,204,21,0.65)',
      none: 'rgba(99,131,255,0.3)',
    };
    return clrs[pt] || 'rgba(99,131,255,0.4)';
  });
 
  ST.chart = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        {
          type: 'line',
          label: 'Temperature (Â°F)',
          data: temps,
          borderColor: 'rgba(249,115,22,0.85)',
          backgroundColor: 'rgba(249,115,22,0.06)',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 4,
          tension: 0.4,
          fill: true,
          yAxisID: 'yTemp',
          order: 1,
        },
        {
          type: 'bar',
          label: 'Precipitation (in)',
          data: precips,
          backgroundColor: precipColors,
          borderRadius: 3,
          yAxisID: 'yPrecip',
          order: 2,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { family: 'Inter', size: 11 } } },
        tooltip: {
          backgroundColor: 'rgba(8,12,35,0.92)',
          borderColor: 'rgba(99,131,255,0.25)',
          borderWidth: 1,
          titleColor: '#e2e8f0',
          bodyColor: '#94a3b8',
          padding: 10,
          callbacks: {
            label: ctx => {
              if (ctx.dataset.yAxisID === 'yTemp')
                return ` ${Math.round(ctx.parsed.y)}Â°F`;
              return ctx.parsed.y > 0 ? ` ${ctx.parsed.y.toFixed(2)}"` : null;
            },
          },
        },
      },
      scales: {
        x: {
          ticks: {
            color: '#475569',
            font: { size: 10 },
            maxRotation: 0,
            maxTicksLimit: 12,
          },
          grid: { color: 'rgba(255,255,255,0.04)' },
        },
        yTemp: {
          position: 'left',
          ticks: { color: '#f97316', font: { size: 11 }, callback: v => `${v}Â°` },
          grid: { color: 'rgba(255,255,255,0.04)' },
        },
        yPrecip: {
          position: 'right',
          min: 0,
          ticks: {
            color: '#22d3ee',
            font: { size: 10 },
            callback: v => v > 0 ? `${v}"` : '',
          },
          grid: { display: false },
        },
      },
    },
  });
}
 
// ============================================================
// RADAR MAP (Leaflet + IEM MRMS tiles)
// ============================================================
function initRadarMap() {
  if (ST.mapsInited.radar) return;
  ST.mapsInited.radar = true;
 
  const map = L.map('radar-map', {
    center: [CFG.lat, CFG.lon],
    zoom: 7,
    zoomControl: true,
  });
  ST.maps.radar = map;
 
  // Dark base layer (CartoDB dark matter)
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© OpenStreetMap contributors Â© CARTO',
    subdomains: 'abcd',
    maxZoom: 19,
  }).addTo(map);
 
  // MRMS / NEXRAD tiles (IEM)
  ST.layers.radar = L.tileLayer(
    `https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/${ST.radarProduct}/{z}/{x}/{y}.png`,
    { opacity: 0.75, attribution: 'IEM MRMS/NEXRAD', maxZoom: 19 }
  ).addTo(map);
 
  // US States overlay
  L.tileLayer(
    'https://mesonet.agron.iastate.edu/c/tile.py/1.0.0/usstates/{z}/{x}/{y}.png',
    { opacity: 0.6, attribution: 'IEM', maxZoom: 19 }
  ).addTo(map);
 
  // Ephrata marker
  L.circleMarker([CFG.lat, CFG.lon], {
    radius: 8,
    color: '#4f7bff',
    fillColor: '#2563eb',
    fillOpacity: 0.85,
    weight: 2,
  }).addTo(map).bindPopup('<b style="color:#e2e8f0">Ephrata, PA</b><br><span style="color:#94a3b8">40.18Â°N 76.19Â°W</span>');
 
  // Timestamp watermark
  const ts = L.control({ position: 'bottomleft' });
  ts.onAdd = () => {
    const d = document.createElement('div');
    d.style.cssText = 'background:rgba(5,10,25,0.7);color:#64748b;padding:3px 7px;font-size:10px;border-radius:5px;font-family:Inter,sans-serif';
    d.id = 'radar-timestamp';
    d.innerHTML = 'MRMS data via Iowa Environmental Mesonet';
    return d;
  };
  ts.addTo(map);
}
 
function setRadarProduct(product) {
  ST.radarProduct = product;
  // Update button states
  document.getElementById('btn-refl').classList.toggle('active', product === 'nexrad-n0q-900913');
  document.getElementById('btn-rate').classList.toggle('active', product === 'q2-iak-900913');
 
  if (ST.layers.radar && ST.maps.radar) {
    ST.maps.radar.removeLayer(ST.layers.radar);
    ST.layers.radar = L.tileLayer(
      `https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/${product}/{z}/{x}/{y}.png`,
      { opacity: 0.75, attribution: 'IEM MRMS', maxZoom: 19 }
    ).addTo(ST.maps.radar);
  }
}
 
function refreshRadar() {
  if (!ST.layers.radar || !ST.maps.radar) return;
  const cur = ST.radarProduct;
  ST.maps.radar.removeLayer(ST.layers.radar);
  ST.layers.radar = L.tileLayer(
    `https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/${cur}/{z}/{x}/{y}.png?_=${Date.now()}`,
    { opacity: 0.75, attribution: 'IEM MRMS', maxZoom: 19 }
  ).addTo(ST.maps.radar);
}
 
// ============================================================
// RADAR PRECIP TYPE GRID (HRRR next 12 hours)
// ============================================================
function renderRadarPtypeGrid(om) {
  const container = document.getElementById('radar-ptype-grid');
  if (!om) { container.innerHTML = '<span class="text-xs text-red-400">HRRR data unavailable</span>'; return; }
 
  const now = new Date();
  const h = om.hourly;
  const pills = [];
 
  for (let i = 0; i < h.time.length && pills.length < 12; i++) {
    const t = new Date(h.time[i]);
    if (t < now) continue;
    const ptype = wmoToPrecipType(h.weather_code[i]);
    const label = precipTypeLabel(ptype);
    const badge = precipTypeBadgeClass(ptype);
    const precip = h.precipitation[i] ?? 0;
    pills.push(`
      <div class="glass-light px-3 py-2 text-center min-w-16">
        <p class="text-xs font-bold text-slate-400">${fmtTime(h.time[i])}</p>
        <span class="text-xs px-1.5 py-0.5 rounded-full ${badge}">${label}</span>
        ${precip > 0 ? `<p class="text-xs text-cyan-400 mt-1">${precip.toFixed(2)}"</p>` : ''}
      </div>`);
  }
 
  container.innerHTML = pills.length
    ? `<p class="text-xs text-slate-500 w-full mb-1">Next 12 hours:</p>` + pills.join('')
    : '<span class="text-xs text-slate-500">No precipitation expected</span>';
}
 
// ============================================================
// SNOWFALL
// ============================================================
function setSnowPeriod(hours) {
  ST.snowPeriod = hours;
  ['24','48','72','168'].forEach(h => {
    document.getElementById(`snow-${h}`)?.classList.toggle('active', parseInt(h) === hours);
  });
  const img = document.getElementById('snow-nohrsc');
  if (img) {
    img.src = '';
    img.src = nohrscUrl(hours);
    img.alt = `NOHRSC ${hours}h Snowfall Analysis`;
    img.onerror = function() {
      // Try previous 6-hour window
      const now = new Date();
      const utcH = now.getUTCHours();
      const prevRunH = (Math.floor(utcH / 6) * 6 - 6 + 24) % 24;
      const d2 = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), prevRunH));
      if (utcH < 6) d2.setUTCDate(d2.getUTCDate() - 1);
      const yyyy = d2.getUTCFullYear();
      const mm = String(d2.getUTCMonth()+1).padStart(2,'0');
      const dd2 = String(d2.getUTCDate()).padStart(2,'0');
      const hh = String(d2.getUTCHours()).padStart(2,'0');
      const key = hours === 168 ? '10day' : `${hours}h`;
      this.onerror = () => { this.closest('.relative').innerHTML = snowFallback(); };
      this.src = `https://www.nohrsc.noaa.gov/snowfall/data/${yyyy}${mm}/sfav3_CONUS_${key}_${yyyy}${mm}${dd2}${hh}.gif`;
    };
  }
}
 
// ============================================================
// SPC
// ============================================================
function setSpcDay(day) {
  ST.spcDay = day;
  [1,2,3].forEach(d => {
    document.getElementById(`spc-d${d}`)?.classList.toggle('active', d === day);
  });
  const urls = {
    1: 'https://www.spc.noaa.gov/products/outlook/day1otlk.gif',
    2: 'https://www.spc.noaa.gov/products/outlook/day2otlk.gif',
    3: 'https://www.spc.noaa.gov/products/outlook/day3otlk.gif',
  };
  const img = document.getElementById('spc-outlook-img');
  if (img) {
    img.src = '';
    img.src = urls[day];
    img.alt = `SPC Day ${day} Convective Outlook`;
  }
}
 
function handleSpcImgError() {
  const img = document.getElementById('spc-outlook-img');
  if (!img) return;
  img.insertAdjacentHTML('afterend',
    `<div class="glass-light p-6 text-center text-slate-500 text-sm mt-2">
      <p class="mb-2">âš ï¸ SPC outlook image unavailable.</p>
      <a href="https://www.spc.noaa.gov/products/outlook/" target="_blank"
         class="text-blue-400 underline">View SPC Outlooks directly â†’</a>
    </div>`);
}
 
// ============================================================
// CONDITIONS MAP (Leaflet + NWS station obs)
// ============================================================
function initConditionsMap(stations) {
  const map = L.map('conditions-map', {
    center: [CFG.lat, CFG.lon],
    zoom: 7,
    zoomControl: true,
  });
  ST.maps.conditions = map;
  ST.mapsInited.conditions = true;
 
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© OpenStreetMap contributors Â© CARTO',
    subdomains: 'abcd',
    maxZoom: 19,
  }).addTo(map);
 
  // Ephrata star marker
  const eph = L.divIcon({
    html: `<div class="stn-pin" style="border-color:#f59e0b;font-size:12px">
             <span style="color:#fbbf24;font-weight:800">â˜… Ephrata</span>
           </div>`,
    className: '',
    iconAnchor: [35, 15],
  });
  L.marker([CFG.lat, CFG.lon], { icon: eph }).addTo(map);
 
  // Station markers
  stations.forEach(s => {
    const tc = tempColor(s.tempF);
    const skyE = skyEmoji(s.sky);
    const wd = windDirArrow(s.windDir);
    const ws = s.windMph != null ? `${Math.round(s.windMph)}` : 'â€“';
    const icon = L.divIcon({
      html: `<div class="stn-pin">
               <div style="color:${tc};font-weight:800;font-size:13px">${Math.round(s.tempF)}Â°F</div>
               <div style="color:#94a3b8;font-size:10px">${skyE} ${wd} ${ws}mph</div>
             </div>`,
      className: '',
      iconAnchor: [35, 25],
    });
    L.marker([s.lat, s.lon], { icon }).addTo(map)
      .bindPopup(`
        <div style="font-family:Inter,sans-serif">
          <p style="font-weight:700;font-size:14px;margin:0 0 6px">${s.name} (${s.id})</p>
          <table style="font-size:12px;color:#94a3b8;border-collapse:collapse">
            <tr><td style="padding:2px 8px 2px 0">Temperature</td>
                <td style="color:${tc};font-weight:700">${Math.round(s.tempF)}Â°F</td></tr>
            <tr><td style="padding:2px 8px 2px 0">Wind</td>
                <td>${ws} mph ${wd}</td></tr>
            <tr><td style="padding:2px 8px 2px 0">Humidity</td>
                <td>${s.humidity != null ? Math.round(s.humidity)+'%' : 'â€”'}</td></tr>
            <tr><td style="padding:2px 8px 2px 0">Sky</td>
                <td>${skyE} ${s.sky}</td></tr>
            <tr><td style="padding:2px 8px 2px 0">Conditions</td>
                <td>${s.textDescription}</td></tr>
          </table>
        </div>`);
  });
 
  // Temperature color legend
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const d = document.createElement('div');
    d.style.cssText = 'background:rgba(5,10,25,0.88);border:1px solid rgba(99,131,255,0.2);border-radius:10px;padding:10px 12px;font-family:Inter,sans-serif;font-size:11px;color:#94a3b8';
    d.innerHTML = `<p style="font-weight:700;margin:0 0 6px;color:#e2e8f0">Temperature</p>
      ${[['â‰¥90Â°','#ef4444'],['80Â°','#f97316'],['70Â°','#f59e0b'],
         ['60Â°','#84cc16'],['50Â°','#22d3ee'],['40Â°','#60a5fa'],
         ['32Â°','#818cf8'],['<32Â°','#c4b5fd']].map(([l,c]) =>
        `<div style="display:flex;align-items:center;gap:6px;margin:2px 0">
           <span style="width:10px;height:10px;background:${c};border-radius:50%;display:inline-block"></span>
           <span>${l}</span></div>`).join('')}`;
    return d;
  };
  legend.addTo(map);
}
 
// ============================================================
// RENDER STATION TABLE
// ============================================================
function renderStationTable(stations) {
  const tbody = document.getElementById('station-table-body');
  if (!stations.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-slate-500">No station data available</td></tr>';
    return;
  }
 
  tbody.innerHTML = stations.map(s => {
    const tc = tempColor(s.tempF);
    const wd = windDirArrow(s.windDir);
    const ws = s.windMph != null ? `${Math.round(s.windMph)} mph ${wd}` : 'â€”';
    return `<tr class="border-b border-slate-800/60 hover:bg-slate-800/20 transition-colors">
      <td class="py-2.5 pr-4">
        <p class="font-semibold text-white text-xs">${s.id}</p>
        <p class="text-xs text-slate-500 leading-tight">${s.name}</p>
      </td>
      <td class="py-2.5 text-right font-bold text-sm" style="color:${tc}">${Math.round(s.tempF)}Â°F</td>
      <td class="py-2.5 text-right text-sm text-slate-300">${ws}</td>
      <td class="py-2.5 text-right text-sm text-slate-400">${s.humidity != null ? Math.round(s.humidity)+'%' : 'â€”'}</td>
      <td class="py-2.5 text-right text-sm">${skyEmoji(s.sky)} ${s.sky}</td>
      <td class="py-2.5 text-right text-xs text-slate-400">${s.textDescription}</td>
    </tr>`;
  }).join('');
}
 
// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById(`tab-${tab}`)?.classList.add('active');
 
  // Lazy-init maps on first visit
  if (tab === 'radar' && !ST.mapsInited.radar) {
    setTimeout(initRadarMap, 50);
  }
  if (tab === 'conditions' && !ST.mapsInited.conditions && ST.stations.length) {
    setTimeout(() => initConditionsMap(ST.stations), 50);
  }
 
  // Re-init snowfall image on first visit
  if (tab === 'snowfall') {
    const img = document.getElementById('snow-nohrsc');
    if (img && !img.src) setSnowPeriod(ST.snowPeriod);
  }
}
 
// Wire up tab buttons
document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});
 
// ============================================================
// MAIN INIT
// ============================================================
async function refreshAll() {
  const btn = document.getElementById('refresh-btn');
  if (btn) btn.classList.add('animate-spin');
 
  try {
    const [omData, nwsForecast, nwsHourly, stations] = await Promise.allSettled([
      fetchOpenMeteo(),
      fetchNWSForecast(),
      fetchNWSHourly(),
      fetchStations(),
    ]);
 
    // Open-Meteo
    if (omData.status === 'fulfilled') {
      ST.openMeteo = omData.value;
      renderHeader(ST.openMeteo);
      renderForecastChart(ST.openMeteo);
      renderRadarPtypeGrid(ST.openMeteo);
      // Re-render hourly with HRRR overlay if NWS is ready
    }
 
    // NWS Forecast
    if (nwsForecast.status === 'fulfilled') {
      ST.nwsForecast = nwsForecast.value;
      renderDailyForecast(ST.nwsForecast);
    }
 
    // NWS Hourly
    if (nwsHourly.status === 'fulfilled') {
      ST.nwsHourly = nwsHourly.value;
      renderHourlyScroll(ST.nwsHourly, ST.openMeteo?.hourly ?? null);
    }
 
    // Stations
    if (stations.status === 'fulfilled') {
      ST.stations = stations.value;
      renderStationTable(ST.stations);
      if (ST.mapsInited.conditions) {
        // already init'd â€“ just rebuild markers
        ST.maps.conditions.eachLayer(l => { if (l instanceof L.Marker) l.remove(); });
        initConditionsMap(ST.stations);
      }
    }
 
    // Hide loading, show content
    document.getElementById('global-loading').classList.add('hidden');
    document.getElementById('tab-forecast').classList.add('active');
 
    // Init snowfall image
    setSnowPeriod(ST.snowPeriod);
 
  } catch (err) {
    console.error(err);
    document.getElementById('global-loading').classList.add('hidden');
    document.getElementById('global-error').classList.remove('hidden');
    document.getElementById('error-text').textContent = err.message;
  } finally {
    if (btn) btn.classList.remove('animate-spin');
  }
}
 
// â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  refreshAll();
  setInterval(refreshAll, CFG.refreshMs);
});
</script>
</body>
</html>
